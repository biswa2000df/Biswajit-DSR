<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biswajit Sahoo - Daily Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Flatpickr CSS (Dark Theme for Space Vibe) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.min.css">

    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050515; /* Deeper space black */
            color: #e0e0e0;
            cursor: default;
        }

        /* Animated Starfield Canvas */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Subtle blue/purple overlay to simulate nebula light */
            background: radial-gradient(circle at 50% 50%, rgba(10, 10, 50, 0.4) 0%, rgba(5, 5, 20, 1) 100%);
        }

        /* Glass Container - Enhanced Glassmorphism */
        .glass-container {
            background: rgba(18, 18, 50, 0.7); /* Slightly lighter for better contrast */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(150, 150, 255, 0.1);
            position: relative;
            animation: fadeIn 1.5s ease-out forwards;
            /* Stronger inner shadow for depth */
            box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(168, 85, 247, 0.1);
        }

        /* Glowing Border Effect (Aurora) */
        .glass-container::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            /* Finer gradient for a softer aurora effect */
            background: conic-gradient(from 180deg at 50% 50%, #4f46e5 0deg, #a855f7 90deg, #4f46e5 180deg, #38bdf8 270deg, #4f46e5 360deg);
            z-index: -1;
            filter: blur(25px); /* Increased blur for soft glow */
            border-radius: 1.5rem;
            opacity: 0.6; /* Soften the overall brightness */
        }

        /* Input Field Styling */
        .form-input {
            background-color: rgba(0, 0, 15, 0.7);
            border: 1px solid rgba(100, 100, 220, 0.2);
            color: #ffffff;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .form-input:focus {
            outline: none;
            border-color: #38bdf8; /* Brighter focus color */
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5), 0 0 5px #38bdf8;
        }

        /* Customizing native date/time icons */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) opacity(0.8);
            cursor: pointer;
        }

        /* Submit Button - Pulsating Energy */
        .submit-btn {
            background: linear-gradient(90deg, #4f46e5, #a855f7);
            box-shadow: 0 0 25px rgba(129, 72, 227, 0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            animation: pulse 3s infinite ease-in-out;
            transform: translateZ(0); /* Force hardware acceleration */
        }

        /* Styles for disabled state */
        .submit-btn:disabled {
            background: #4a4a58; /* Darker, inactive color */
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
            animation: none;
        }

        .submit-btn:not(:disabled):hover {
            background: linear-gradient(90deg, #38bdf8, #a855f7);
            transform: scale(1.02);
            box-shadow: 0 0 40px rgba(56, 189, 248, 0.8);
        }

        /* ----------------------------------------------------- */
        /* AI REWRITE BUTTON DESIGN */
        /* ----------------------------------------------------- */
        .gemini-btn {
            background: rgba(10, 10, 30, 0.8); /* Darker internal fill */
            border: 2px solid transparent;
            color: #ffffff;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            z-index: 10;
            /* NEW: Apply the whole-box pulsating shadow */
            animation: gemini-pulse-shadow 4s infinite ease-in-out;
            transform: translateZ(0);
        }

        .gemini-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 9999px; /* Tailwind 'rounded-full' */
            padding: 2px; /* Border width */
            /* Holographic Border Effect - Cyan to Purple */
            background: linear-gradient(45deg, #38bdf8, #a855f7, #38bdf8) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            transition: all 0.5s ease;
        }

        .gemini-btn:hover::before {
            background: linear-gradient(45deg, #a855f7, #38bdf8, #a855f7) border-box; /* Reverse gradient on hover */
            filter: blur(2px); /* Subtle glow effect on border */
        }

        /* Glowing Logo inside the AI Rewrite button */
        .gemini-logo {
            /* Use filter drop-shadow for a clean glow effect on the emoji */
            animation: logo-pulse 2s infinite ease-in-out;
        }
        /* ----------------------------------------------------- */

        /* ----------------------------------------------------- */
        /* TOAST NOTIFICATION STYLES (New) */
        /* ----------------------------------------------------- */
        #toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 250px;
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 600;
            /* Glassmorphism background for the toast */
            background: rgba(18, 18, 50, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(150, 150, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(120%); /* Start off-screen */
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #toast-notification.show {
            transform: translateX(0); /* Slide in */
        }

        #toast-notification.success {
            /* Left border indicator for success */
            border-left: 5px solid #10b981; /* Tailwind emerald-500 */
        }

        #toast-notification.error {
            /* Left border indicator for error */
            border-left: 5px solid #ef4444; /* Tailwind red-500 */
        }
        /* ----------------------------------------------------- */

        /* ----------------------------------------------------- */
        /* CUSTOM CALENDAR STYLES (ENHANCED HOLOGRAPHIC LOOK)    */
        /* ----------------------------------------------------- */

        /* Main Calendar Container */
        .flatpickr-calendar {
            background: rgba(15, 23, 42, 0.95) !important; /* Deep slate */
            border: 1px solid rgba(56, 189, 248, 0.3) !important; /* Cyan border */
            border-radius: 1rem !important;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8), 0 0 20px rgba(56, 189, 248, 0.15) !important;
            font-family: 'Inter', sans-serif !important;
            backdrop-filter: blur(15px) !important;
            width: 320px !important; /* Slightly wider for breathing room */
        }

        /* Header Area (Month/Year) */
        .flatpickr-months {
            background: transparent !important;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 5px;
            padding-top: 5px;
        }

        .flatpickr-current-month {
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            color: #e2e8f0 !important; /* Light text */
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month input.cur-year {
            color: #e2e8f0 !important;
            font-weight: 700 !important;
        }

        /* Navigation Arrows */
        .flatpickr-prev-month svg, .flatpickr-next-month svg {
            fill: #94a3b8 !important; /* Slate gray */
            transition: fill 0.3s ease;
        }
        .flatpickr-prev-month:hover svg, .flatpickr-next-month:hover svg {
            fill: #38bdf8 !important; /* Cyan on hover */
            filter: drop-shadow(0 0 5px #38bdf8);
        }

        /* Weekdays row */
        .flatpickr-weekdays {
            background: transparent !important;
            margin-top: 5px;
        }

        span.flatpickr-weekday {
            color: #64748b !important; /* Muted slate */
            font-weight: 600 !important;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        /* Day Cells - Default State */
        .flatpickr-day {
            color: #cbd5e1 !important; /* Light slate text */
            border-radius: 0.5rem !important; /* Rounded squares */
            border: 1px solid transparent !important;
            transition: all 0.2s ease;
            background: transparent;
            margin: 2px 0; /* Vertical spacing */
            height: 36px;
            line-height: 36px;
        }

        /* Hover State for Normal Days */
        .flatpickr-day:hover {
            background: rgba(56, 189, 248, 0.15) !important;
            border-color: #38bdf8 !important;
            color: #ffffff !important;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
        }

        /* Today's Date */
        .flatpickr-day.today {
            border-color: #a855f7 !important; /* Purple border */
            background: rgba(168, 85, 247, 0.1) !important;
            color: #e879f9 !important;
        }

        /* Selected Date */
        .flatpickr-day.selected {
            background: linear-gradient(135deg, #38bdf8, #2563eb) !important; /* Cyan to Blue */
            color: #ffffff !important;
            border-color: transparent !important;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.6) !important;
            font-weight: bold;
        }

        /* ALREADY FILLED DATES - IMPROVED DESIGN
           Concept: "Deactivated Sci-Fi Panel"
        */
        .flatpickr-day.already-filled-date {
            /* Dark background with diagonal stripes pattern */
            background: repeating-linear-gradient(
                45deg,
                rgba(30, 41, 59, 0.4),
                rgba(30, 41, 59, 0.4) 5px,
                rgba(15, 23, 42, 0.4) 5px,
                rgba(15, 23, 42, 0.4) 10px
            ) !important;

            color: #64748b !important; /* Dim text color */
            border: 1px solid rgba(148, 163, 184, 0.2) !important; /* Faint border */
            position: relative;
        }

        /* Success Checkmark Indicator */
        .flatpickr-day.already-filled-date::after {
            content: 'âœ“';
            position: absolute;
            top: 1px;
            right: 3px;
            font-size: 10px;
            color: #10b981; /* Emerald green glow */
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
            font-weight: bold;
        }

        /* Hover Effect for Filled Dates (Showing it's clickable/editable) */
        .flatpickr-day.already-filled-date:hover {
            background: rgba(56, 189, 248, 0.1) !important; /* Slight Cyan fill */
            border-color: #38bdf8 !important; /* Cyan border */
            color: #ffffff !important; /* Bright white text */
            cursor: pointer;
            /* Remove stripes on hover for clarity */
            background-image: none !important;
        }

        /* DISABLED DATES (Prev/Next Month) - Explicit Styling */
        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            opacity: 0.1 !important;
            pointer-events: none !important;
            cursor: default !important;
        }

        .flatpickr-day.flatpickr-disabled:hover {
            background: transparent !important;
            border-color: transparent !important;
            cursor: default !important;
        }

        /* ----------------------------------------------------- */


        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 25px rgba(129, 72, 227, 0.8);
            }
            50% {
                box-shadow: 0 0 45px rgba(168, 85, 247, 1);
            }
        }

        @keyframes gemini-pulse-shadow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.5), 0 0 5px rgba(56, 189, 248, 0.8);
            }
            50% {
                /* Shifts slightly towards purple at the peak of the pulse */
                box-shadow: 0 0 30px rgba(56, 189, 248, 1), 0 0 10px rgba(168, 85, 247, 0.5);
            }
        }

        /* Keyframe for the glowing logo effect */
        @keyframes logo-pulse {
            0%, 100% {
                /* Subtle white/cyan glow */
                filter: drop-shadow(0 0 1px #fff) drop-shadow(0 0 4px #38bdf8);
                opacity: 1;
            }
            50% {
                /* Stronger white/magenta glow */
                filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 10px #a855f7);
                opacity: 0.8;
            }
        }
    </style>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<!-- Canvas for the animated starfield background with parallax -->
<canvas id="starfield"></canvas>

<!-- New Toast Notification Element (Top Right) -->
<div id="toast-notification" class="flex items-center space-x-3" role="alert" aria-live="assertive">
    <span id="toast-icon">ðŸš€</span>
    <span id="toast-message"></span>
</div>

<div class="glass-container w-full max-w-2xl p-8 md:p-12 rounded-3xl shadow-2xl">
    <!-- Header Section -->
    <div class="text-center mb-8">
        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500 mb-2 tracking-tighter">
            BISWAJIT SAHOO
        </h1>
        <p class="text-md text-gray-400 font-bold">Daily Progress Report</p>
    </div>

    <!-- Form Section -->
    <form id="log-form" action="#" method="POST" class="space-y-6" onsubmit="return false;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Log ID (Now Auto-Populated and Mandatory) -->
            <div>
                <label for="si_no" class="block mb-2 text-sm font-medium text-cyan-300">Sequence No.<span class="text-red-500 ml-1">*</span></label>
                <input type="number" id="si_no" name="si_no" class="form-input w-full p-3 rounded-xl focus:ring-2 focus:ring-cyan-500" placeholder="e.g., 15" readonly>
            </div>
            <!-- Date -->
            <div>
                <label for="date" class="block mb-2 text-sm font-medium text-cyan-300">Date<span class="text-red-500 ml-1">*</span></label>
                <input type="date" id="date" name="date" class="form-input w-full p-3 rounded-xl focus:ring-2 focus:ring-cyan-500">
            </div>
        </div>

        <!-- Daily Status Report -->
        <div>
            <div class="flex justify-between items-center mb-2">
                <label for="work_done" class="block text-sm font-medium text-cyan-300">Daily Status Report<span class="text-red-500 ml-1">*</span></label>
                <!-- IMPRESSIVE AI REWRITE BUTTON -->
                <button type="button" id="gemini-suggest-btn" class="gemini-btn text-xs font-semibold py-2 px-4 rounded-full flex items-center space-x-1 uppercase tracking-wider">
                    <span class="text-lg gemini-logo">âœ¨</span>
                    <span>AI Rewrite (via N8N)</span>
                </button>
            </div>
            <textarea id="work_done" name="work_done" rows="5" class="form-input w-full p-4 rounded-xl focus:ring-2 focus:ring-cyan-500" placeholder="Enter keywords (e.g., 'fixed UI bug on login') or a draft, then click AI Rewrite..."></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Start Time -->
            <div>
                <label for="in_time" class="block mb-2 text-sm font-medium text-cyan-300">Start Time <span class="text-red-500 ml-1">*</span></label>
                <input type="time" id="in_time" name="in_time" class="form-input w-full p-3 rounded-xl focus:ring-2 focus:ring-cyan-500">
            </div>
            <!-- End Time -->
            <div>
                <label for="out_time" class="block mb-2 text-sm font-medium text-cyan-300">End Time<span class="text-red-500 ml-1">*</span></label>
                <input type="time" id="out_time" name="out_time" class="form-input w-full p-3 rounded-xl focus:ring-2 focus:ring-cyan-500">
            </div>
        </div>

        <!-- Finalize Report -->
        <div>
            <button type="submit" id="submit-btn" class="submit-btn w-full text-white font-bold py-4 px-4 rounded-xl text-lg uppercase tracking-widest" disabled>
                Finalize Report
            </button>
        </div>
        <!-- Removed old message container -->
    </form>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Starfield Animation (Unchanged) ---
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        const numStars = 500;
        const stars = [];
        let mouseX = 0;
        let mouseY = 0;
        const parallaxFactor = 0.008;

        function setCanvasSize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        setCanvasSize();
        window.addEventListener('resize', setCanvasSize);
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        class Star {
            constructor(x, y, radius, alpha, velocity) {
                this.x = x; this.y = y; this.radius = radius;
                this.alpha = alpha; this.velocity = velocity;
                this.parallaxDepth = (radius / 1.5);
            }
            draw(x, y) {
                ctx.beginPath();
                ctx.arc(x, y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.fill();
            }
            update() {
                this.y -= this.velocity;
                if (this.y < -this.radius) {
                    this.y = canvas.height + this.radius;
                    this.x = Math.random() * canvas.width;
                }
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const offsetX = (mouseX - centerX) * parallaxFactor;
                const offsetY = (mouseY - centerY) * parallaxFactor;
                const adjustedX = this.x - (this.parallaxDepth * offsetX);
                const adjustedY = this.y - (this.parallaxDepth * offsetY);
                this.draw(adjustedX, adjustedY);
            }
        }

        function initStars() {
            for (let i = 0; i < numStars; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 1.5 + 0.5;
                const alpha = Math.random() * 0.7 + 0.3;
                const velocity = Math.random() * 0.5 + 0.1;
                stars.push(new Star(x, y, radius, alpha, velocity));
            }
        }

        function animateStars() {
            ctx.fillStyle = 'rgba(5, 5, 20, 0.4)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => star.update());
            requestAnimationFrame(animateStars);
        }

        initStars();
        animateStars();


       // --- N8N API Integration URLs ---
       const N8N_REWRITE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/AI_GenerateWorkDone";
       const N8N_SUBMIT_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/submitButton";
       // NEW: URL for fetching filled dates
       const N8N_DATE_FILL_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/dateFill";
       // NEW: URL for fetching specific work done
       const N8N_EDIT_WORK_DONE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/editWorkDone";


        // --- Element References ---
        const logForm = document.getElementById('log-form');
        const submitBtn = document.getElementById('submit-btn');
        // NEW TOAST ELEMENTS
        const toastNotification = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        const workDoneTextarea = document.getElementById('work_done');
        const suggestBtn = document.getElementById('gemini-suggest-btn');

        const siNoInput = document.getElementById('si_no');
        const dateInput = document.getElementById('date');
        const inTimeInput = document.getElementById('in_time');
        const outTimeInput = document.getElementById('out_time');

        // --- NEW: Custom Calendar Logic (Flatpickr Integration) ---
        let filledDays = []; // Store days (1-31) that are already filled

        // Function to fetch filled dates (Runs on Open)
        async function fetchFilledDates(instance) {
            console.log("Calendar Opened: Fetching filled dates from API...");
            try {
                // REPLACED: Updated to use retry logic for consistency
                const response = await fetchWithExponentialBackoff(N8N_DATE_FILL_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data && Array.isArray(data.AlreadyFieldDate)) {
                        // Ensure we work with Numbers so 1 == 1 (not "1" == 1)
                        filledDays = data.AlreadyFieldDate.map(d => Number(d));
                        console.log("Fetched filled dates successfully:", filledDays);
                        // Force redraw to apply styles immediately
                        if (instance) instance.redraw();
                    } else {
                        console.log("Data received but format was unexpected:", data);
                    }
                } else {
                    console.warn(`Failed to fetch filled dates. Status: ${response.status}`);
                }
            } catch (error) {
                console.error("Error fetching filled dates:", error);
            }
        }

        // Helper: Convert 12h AM/PM (e.g. "9:42 AM") to 24h ("09:42")
        function convert12hTo24h(timeStr) {
            if (!timeStr) return '';
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!match) return ''; // Return empty if format doesn't match

            let [_, hours, minutes, modifier] = match;
            hours = parseInt(hours, 10);

            if (hours === 12 && modifier.toUpperCase() === 'AM') {
                hours = 0;
            } else if (hours !== 12 && modifier.toUpperCase() === 'PM') {
                hours += 12;
            }

            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        // Function to fetch specific work done for a date (Runs on Change)
        async function fetchWorkDoneForDate(dayNumber) {
            console.log(`Date Selected: Fetching work done for day ${dayNumber}...`);
            showMessage("Fetching data for selected date...", false);

            try {
                // FIXED: Now using fetchWithExponentialBackoff to handle transient network/CORS issues
                // Standardizing to POST as explicitly requested for sending data bodies
                const response = await fetchWithExponentialBackoff(N8N_EDIT_WORK_DONE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ "preFieldDate": String(dayNumber) })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Fetched Work Done Data:", data);

                    const record = data.PreFieldValueBasedOnDate;
                    if (record) {
                        // Update Sequence No
                        if (record["SI No"]) siNoInput.value = record["SI No"];

                        // Handle Work Done & Time Logic
                        if (record["WorkDone"] && record["WorkDone"].trim() !== "") {
                            // CASE 1: Data Exists - Populate Fields
                            workDoneTextarea.value = record["WorkDone"];
                            if (record["InTime"]) inTimeInput.value = convert12hTo24h(record["InTime"]);
                            if (record["OutTime"]) outTimeInput.value = convert12hTo24h(record["OutTime"]);
                            showMessage("Data loaded for selected date.", false);
                        } else {
                            // CASE 2: Empty Data (Not filled yet) - Reset to "Normal Display"
                            // "normal display" means default calc values for a new entry
                            workDoneTextarea.value = "";

                            // Re-initialize time to current default (like a fresh load)
                            const today = new Date();
                            const hours = String(today.getHours()).padStart(2, '0');
                            const minutes = String(today.getMinutes()).padStart(2, '0');
                            const formattedTime = `${hours}:${minutes}`;

                            inTimeInput.value = formattedTime;
                            outTimeInput.value = calculateEndTime(formattedTime);

                            // Log ID is already updated by updateLogIdBasedOnDate logic
                        }

                        // Re-run validation
                        checkFormValidity();
                    }
                } else {
                    console.warn("Failed to fetch work done details.");
                }
            } catch (error) {
                console.error("Error fetching work done details:", error);
                showMessage("Failed to fetch data. Check network/CORS.", true);
            }
        }

        // Initialize Flatpickr
        const fp = flatpickr("#date", {
            dateFormat: "Y-m-d",
            theme: "dark", // Using dark theme to match site
            disableMobile: "true", // Force custom picker on mobile to show grayed out effect
            onOpen: function(selectedDates, dateStr, instance) {
                // REQ: "when i click on the the calender button then call the api"
                // Pass the instance so we can redraw it once data arrives
                fetchFilledDates(instance);
            },
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                // Logic: "day is gray out meand clickable but but grayout"

                // Requirement 1: STRICTLY DISABLE padding days from prev/next months
                if (dayElem.classList.contains("prevMonthDay") || dayElem.classList.contains("nextMonthDay")) {
                    dayElem.classList.add("flatpickr-disabled");
                    dayElem.style.opacity = "0.1"; // Visually fade out almost completely
                    dayElem.style.pointerEvents = "none"; // Make unclickable
                    return; // Stop processing so we don't accidentally style them as filled
                }

                // Get the day number of the date being rendered (1-31)
                const dayNumber = dayElem.dateObj.getDate();

                // Requirement 2: Handle filled days (gray but clickable)
                if (filledDays.includes(dayNumber)) {
                    dayElem.classList.add("already-filled-date");
                }
            },
            onChange: function(selectedDates, dateStr, instance) {
                // Ensure the native input event fires so our existing logic runs
                dateInput.value = dateStr;
                dateInput.dispatchEvent(new Event('input'));

                // NEW: Trigger API to fetch data for the selected day
                if (selectedDates.length > 0) {
                    const dayNumber = selectedDates[0].getDate();
                    fetchWorkDoneForDate(dayNumber);
                }
            }
        });

        // --- Time Formatting Utility ---
        /**
         * Converts a 24-hour time string (HH:MM) to a 12-hour AM/PM string (H:MM AM/PM).
         */
        function formatTimeForN8N(time24h) {
            if (!time24h) return '';
            const [hours, minutes] = time24h.split(':').map(Number);

            let h = hours;
            const m = String(minutes).padStart(2, '0');
            let modifier = 'AM';

            if (h === 0) {
                h = 12; // Midnight is 12 AM
            } else if (h === 12) {
                modifier = 'PM'; // Noon is 12 PM
            } else if (h > 12) {
                h = h - 12;
                modifier = 'PM';
            }

            return `${h}:${m} ${modifier}`;
        }

        // --- 9-Hour Shift Calculation ---
        /**
         * Calculates the time exactly 9 hours after the given 24-hour time string.
         * Returns time in HH:MM (24-hour format).
         */
        function calculateEndTime(startTime24h) {
            if (!startTime24h) return '';
            const [startHour, startMinute] = startTime24h.split(':').map(Number);
            const shiftHours = 9;

            let endHour = startHour + shiftHours;
            let endMinute = startMinute; // Minutes remain the same

            // Handle wrap-around midnight (e.g., 23:00 + 9 hours = 08:00 next day)
            if (endHour >= 24) {
                endHour %= 24;
            }

            // Format back to HH:MM string (24-hour)
            const formattedEndHour = String(endHour).padStart(2, '0');
            const formattedEndMinute = String(endMinute).padStart(2, '0');

            return `${formattedEndHour}:${formattedEndMinute}`;
        }


        // --- Core Log ID Auto-Population Logic ---
        function updateLogIdBasedOnDate(dateString) {
            if (dateString) {
                // dateString is already in YYYY-MM-DD format
                // Use a local date object to avoid timezone issues when getting the day
                const dayOfMonth = new Date(dateString + 'T00:00:00').getDate();
                // Set the log ID to the day of the month
                siNoInput.value = dayOfMonth;
            } else {
                siNoInput.value = '';
            }
            checkFormValidity();
        }

        // --- Time and Date Initialization for User Convenience (IMPROVED DATE LOGIC) ---
        function initializeDateTime() {
            const today = new Date();

            // 1. Get current date using LOCAL methods
            const year = today.getFullYear();
            // getMonth() is 0-indexed, so add 1
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // 2. Get current time in HH:MM format (24-hour)
            const hours = String(today.getHours()).padStart(2, '0');
            const minutes = String(today.getMinutes()).padStart(2, '0');
            const formattedTime = `${hours}:${minutes}`;

            // Set values

            // NOTE: Flatpickr controls the value, so we update via Flatpickr instance
            fp.setDate(formattedDate);
            // Also manually trigger the update logic since programmatic set might not trigger 'change'
            updateLogIdBasedOnDate(formattedDate);

            inTimeInput.value = formattedTime;

            // Automatically set end time 9 hours later
            outTimeInput.value = calculateEndTime(formattedTime);

            // Automatically set Log ID based on current day
            // updateLogIdBasedOnDate(formattedDate); // Already called above
        }

        // --- Form Validation Logic (Explicitly checks all fields are non-empty) ---
        function checkFormValidity() {
            // Log ID is auto-populated but must still contain a value.
            const isSiNoValid = siNoInput.value.trim() !== '';
            const isDateValid = dateInput.value.trim() !== '';
            const isWorkDoneValid = workDoneTextarea.value.trim() !== '';
            const isInTimeValid = inTimeInput.value.trim() !== '';
            const isOutTimeValid = outTimeInput.value.trim() !== '';

            // Enable button only if ALL fields are valid (filled)
            submitBtn.disabled = !(isSiNoValid && isDateValid && isWorkDoneValid && isInTimeValid && isOutTimeValid);
        }

        // Initialize values and check validity on load
        initializeDateTime();
        checkFormValidity();

        // Add listeners to update button state dynamically, excluding siNoInput as it's date-driven
        [dateInput, workDoneTextarea, inTimeInput, outTimeInput].forEach(input => {
            input.addEventListener('input', checkFormValidity);
        });

        // Add listener to date input to auto-update Log ID and re-check validity
        dateInput.addEventListener('input', (e) => {
            updateLogIdBasedOnDate(e.target.value);
        });

        // --- Automatic End Time Update on Start Time Change ---
        inTimeInput.addEventListener('input', (e) => {
            const newStartTime = e.target.value;
            outTimeInput.value = calculateEndTime(newStartTime);
            checkFormValidity();
        });


        // --- NEW: Function to display messages as a Toast Notification ---
        function showMessage(message, isError = false) {
            // Reset classes
            toastNotification.classList.remove('show', 'success', 'error');

            // Set message and style
            toastMessage.textContent = message;
            if (isError) {
                toastNotification.classList.add('error');
                toastIcon.textContent = 'ðŸš¨'; // Error icon
            } else {
                toastNotification.classList.add('success');
                toastIcon.textContent = 'âœ…'; // Success icon
            }

            // Show the toast (slide in)
            toastNotification.classList.add('show');

            // Hide the toast after 5 seconds (slide out)
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 5000);
        }


        // --- Form Submission Logic (Finalize Report) ---
        logForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default browser form submission

            if (submitBtn.disabled) {
                showMessage("All mandatory fields must be completed before finalizing the report.", true);
                return;
            }

            // --- CONVERT TIME TO AM/PM FORMAT HERE ---
            const formattedInTime = formatTimeForN8N(inTimeInput.value);
            const formattedOutTime = formatTimeForN8N(outTimeInput.value);

            const originalButtonText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>FINALIZING...</span>`;
            submitBtn.disabled = true;

            // --- USE FORMATTED TIME IN PAYLOAD ---
            const submissionPayload = {
                "Log ID": siNoInput.value,
                "Date": dateInput.value,
                "Daily Status Report": workDoneTextarea.value,
                "StartTime": formattedInTime, // Sent as 12h AM/PM
                "EndTime": formattedOutTime,   // Sent as 12h AM/PM
                "submittedAt": new Date().toISOString(),
                "formMode": "web-submission"
            };

            let response;
            try {
                response = await fetchWithExponentialBackoff(N8N_SUBMIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionPayload)
                });

                if (response.ok) {
                    showMessage("Report Finalized Successfully! N8N received the data.", false);
                    logForm.reset();
                    initializeDateTime(); // Re-initialize date/time and Log ID
                    checkFormValidity();
                } else {
                    const errorText = await response.text();
                    throw new Error(`N8N Webhook failure (${response.status}): ${errorText.substring(0, 100)}...`);
                }

            } catch (error) {
                let errorMessage = `Finalization Failed. Error: ${error.message}`;
                if (error.message.includes("Failed to fetch")) {
                    errorMessage = "Finalization Failed (Network Error). Check Console for CORS Policy Block and ensure N8N allows your domain.";
                }
                console.error('Error during log transmission:', error);
                showMessage(errorMessage, true);
            } finally {
                submitBtn.innerHTML = originalButtonText;
                // Only re-enable if there was an error, otherwise it stays disabled until valid input is given.
                if (!response?.ok) {
                    submitBtn.disabled = false;
                }
            }
        });

        // --- AI Rewrite Logic (via N8N) ---
        suggestBtn.addEventListener('click', async () => {
            const userQuery = workDoneTextarea.value.trim();
            if (!userQuery) {
                showMessage("Enter keywords first (e.g., 'fixed gravity shielding') before AI Rewrite.", true);
                return;
            }

            const originalButtonText = suggestBtn.innerHTML;
            suggestBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>N8N Processing...</span>`;
            suggestBtn.disabled = true;

            const payload = { keywords: userQuery };

            try {
                const response = await fetchWithExponentialBackoff(N8N_REWRITE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`AI Rewrite Webhook error: HTTP status ${response.status}`);
                }

                // IMPORTANT: This relies on N8N Node 4 sending back JSON like {"rewritten_text": "..."}
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                      // Catch the 'Failed to execute 'text' or 'json' error specifically.
                    throw new Error("Invalid response body from N8N. Ensure your 'Respond to Webhook' node is returning valid JSON, not an empty body.");
                }


                if (result && result.rewritten_text) {
                    workDoneTextarea.value = result.rewritten_text.trim();
                    showMessage("AI Rewrite successful. Check log entry.", false);
                } else {
                    // Fallback to text if JSON structure is unexpected (though N8N should be fixed now)
                    const textResult = await response.text();
                    if (textResult) {
                        workDoneTextarea.value = textResult.trim();
                        showMessage("AI Rewrite successful, but JSON format was unexpected.", false);
                    } else {
                          throw new Error("Invalid/Empty response from AI Rewrite N8N. Ensure your final node returns JSON with key 'rewritten_text'.");
                    }
                }

            } catch (error) {
                let errorMessage = `AI Rewrite communication failure. Error: ${error.message}`;
                if (error.message.includes("Failed to fetch")) {
                    errorMessage = "AI Rewrite Failed (Network Error). **CRITICAL: Check N8N for CORS Policy Block** and ensure your 'Respond to Webhook' node is configured correctly.";
                }
                console.error('Error calling AI Rewrite Webhook:', error);
                showMessage(errorMessage, true);
            } finally {
                suggestBtn.innerHTML = originalButtonText;
                suggestBtn.disabled = false;
                checkFormValidity();
            }
        });

        // --- Fetch with Exponential Backoff (Unchanged) ---
        async function fetchWithExponentialBackoff(url, options, retries = 4, delay = 1000) {
            try {
                return await fetch(url, options);
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }
    });
</script>
</body>

</html>
