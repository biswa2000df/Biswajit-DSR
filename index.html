<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Secure Engineering Progress Log Workspace. Track daily tasks, hours, and project status with AI-enhanced reporting and biometric-style authentication.">
    <meta name="keywords" content="Engineering Log, Daily Report, Workspace, Developer Tools, Productivity, Time Tracking, AI Enhanced, Voice Dictation">
    <meta name="author" content="Biswajit Sahoo">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Biswajit Sahoo | Engineering Workspace">
    <meta property="og:description" content="Secure daily engineering log and status tracking terminal.">
    <meta property="og:site_name" content="Engineering Log Workspace">

    <title>Workspace | Secure Access</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts: Inter for UI, JetBrains Mono for Data -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.2)',
                            border: 'rgba(255, 255, 255, 0.08)',
                        },
                        accent: {
                            cyan: '#00f0ff',
                            purple: '#7000ff',
                            danger: '#ef4444',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scanline': 'scanline 8s linear infinite',
                        'grid-flow': 'gridFlow 20s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'laser': 'laser 3s cubic-bezier(0.4, 0, 0.2, 1) infinite',
                        'rotate-slow': 'spin 12s linear infinite',
                        'recording-pulse': 'recordingPulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        scanline: {
                            '0%': { backgroundPosition: '0% 0%' },
                            '100%': { backgroundPosition: '0% 100%' },
                        },
                        gridFlow: {
                            '0%': { backgroundPosition: '0% 0%' },
                            '100%': { backgroundPosition: '0% 100%' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        laser: {
                            '0%': { top: '-10%', opacity: 0 },
                            '10%': { opacity: 1 },
                            '90%': { opacity: 1 },
                            '100%': { top: '110%', opacity: 0 },
                        },
                        recordingPulse: {
                            '0%, 100%': { opacity: 1, transform: 'scale(1)' },
                            '50%': { opacity: 0.5, transform: 'scale(0.95)' },
                        }
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE AESTHETICS --- */
        body {
            background-color: #030712;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ambient Background blobs */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background:
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(6, 182, 212, 0.15), transparent 25%);
            pointer-events: none;
        }

        /* --- GLOBAL LOADER --- */
        #global-loader {
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #global-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .loader-ring {
            width: 60px; height: 60px;
            border: 4px solid transparent;
            border-top-color: #06b6d4;
            border-right-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-ring::before {
            content: ''; position: absolute; inset: 0;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #06b6d4;
            border-right-color: transparent;
            opacity: 0.5;
            animation: spin 2s linear infinite reverse;
        }

        /* --- LOGIN PAGE PREMIUM STYLES --- */
        #login-view {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #020617; /* Deepest Navy/Black */
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            overflow: hidden;
            padding: 1rem; /* Safety padding for mobile */
        }

        /* 3D Cyber Grid Background */
        .cyber-grid {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image:
                linear-gradient(rgba(6, 182, 212, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(6, 182, 212, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: gridFlow 10s linear infinite;
            pointer-events: none;
            mask-image: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 70%);
            -webkit-mask-image: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 70%);
        }

        #login-view.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Premium Glass Card */
        .login-card {
            width: 100%;
            max-width: 440px;
            background: rgba(10, 15, 30, 0.6);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 2rem 1.5rem; /* Mobile first padding */
            box-shadow:
                0 0 0 1px rgba(0, 0, 0, 0.5),
                0 25px 50px -12px rgba(0, 0, 0, 0.8),
                0 0 100px -20px rgba(6, 182, 212, 0.15); /* Cyan Glow */
            position: relative;
            overflow: hidden;
            animation: float 8s ease-in-out infinite;
        }

        @media (min-width: 640px) {
            .login-card {
                padding: 3.5rem 2.5rem;
            }
        }

        /* Scanner Line */
        .login-scanner {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #06b6d4, transparent);
            box-shadow: 0 0 15px #06b6d4;
            opacity: 0.8;
            z-index: 10;
            pointer-events: none;
            animation: laser 3.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        /* Tech Corners */
        .corner-accent {
            position: absolute;
            width: 15px;
            height: 15px;
            border-color: rgba(6, 182, 212, 0.6);
            border-style: solid;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .login-card:hover .corner-accent { border-color: #06b6d4; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(6,182,212,0.4); }
        .tl { top: 0; left: 0; border-width: 2px 0 0 2px; border-radius: 24px 0 0 0; }
        .tr { top: 0; right: 0; border-width: 2px 2px 0 0; border-radius: 0 24px 0 0; }
        .bl { bottom: 0; left: 0; border-width: 0 0 2px 2px; border-radius: 0 0 0 24px; }
        .br { bottom: 0; right: 0; border-width: 0 2px 2px 0; border-radius: 0 0 24px 0; }

        /* Input Field styling */
        .login-input-group {
            position: relative;
            margin-bottom: 2rem;
        }

        .login-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            font-size: 1.75rem; /* Responsive font size */
            letter-spacing: 0.15em;
            padding: 1rem;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            font-weight: 700;
        }

        @media (min-width: 640px) {
            .login-input { font-size: 2rem; }
        }

        .login-input:focus {
            outline: none;
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.1);
            transform: scale(1.02);
        }

        .login-input.error {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Primary Button (Premium) */
        .btn-premium {
            background: #fff;
            color: #000;
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-premium::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, #06b6d4, #8b5cf6, #06b6d4);
            background-size: 200% 100%;
            z-index: -1;
            transition: opacity 0.3s;
            animation: shimmer 3s infinite linear;
            opacity: 0;
        }
        .btn-premium:not(:disabled):hover {
            color: #fff;
        }
        .btn-premium:not(:disabled):hover::before {
            opacity: 1;
        }
        .btn-premium:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.3);
            cursor: not-allowed;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- DASHBOARD & SHARED STYLES --- */
        .pro-card {
            background: rgba(10, 10, 15, 0.75);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
        }

        .pro-card::before {
             content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
             background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
             opacity: 0.5; pointer-events: none; z-index: 0;
        }

        #dashboard-view {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            display: none;
            width: 100%;
            max-width: 48rem;
        }
        #dashboard-view.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Inputs */
        .pro-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .pro-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.2);
        }
        .pro-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; font-weight: 600; margin-bottom: 0.5rem; display: block;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.15em;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #1e293b; color: #64748b; cursor: not-allowed; filter: grayscale(1); }

        /* NEW AI BUTTON DESIGN */
        .btn-ai-new {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 99px;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-ai-new span {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(to right, #c4b5fd, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-ai-new:hover {
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            transform: translateY(-1px);
        }
        .btn-ai-new svg {
            color: #c4b5fd;
        }

        /* NEW LOGOUT BUTTON */
        .btn-logout {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #fff;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        /* GENERIC ICON BUTTON (Copy, Voice) */
        .btn-icon-action {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .btn-icon-action:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #cbd5e1;
            color: #fff;
        }
        .btn-icon-action:active {
            transform: scale(0.95);
        }

        /* Voice specific states */
        .btn-icon-action.recording {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
            color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .btn-status {
            background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.3); color: #22d3ee;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;
            padding: 6px 12px; display: flex; align-items: center; gap: 6px; border-radius: 8px;
            transition: all 0.3s; cursor: pointer;
        }
        .btn-status:hover {
            background: rgba(6, 182, 212, 0.2); box-shadow: 0 0 15px rgba(6, 182, 212, 0.3); color: white;
        }

        .chip {
            font-size: 0.7rem; padding: 6px 12px; border-radius: 4px; background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2); color: #94a3b8; cursor: pointer; transition: all 0.2s;
            white-space: nowrap; user-select: none;
        }
        .chip:hover {
            background: rgba(6, 182, 212, 0.2); border-color: rgba(6, 182, 212, 0.6); color: #fff;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        /* NEW PENTAGONAL DURATION WIDGET */
        .widget-gauge-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            filter: drop-shadow(0 0 8px rgba(6, 182, 212, 0.2));
        }

        .widget-gauge-bg {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(139, 92, 246, 0.2));
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            z-index: 0;
            animation: pulse-slow 3s infinite alternate;
        }

        .widget-gauge-pentagon {
            width: 96px;
            height: 96px;
            background: #030712;
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .pentagon-ring {
            position: absolute;
            inset: 0;
            background: conic-gradient(from 0deg, transparent 20%, #06b6d4 50%, #8b5cf6 80%, transparent 100%);
            animation: spin 4s linear infinite;
            opacity: 0.3;
            z-index: -1;
        }

        /* ENHANCED TOAST */
        #toast-notification {
            transform: translateY(-150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border-left: 4px solid #06b6d4;
            background: rgba(10, 10, 15, 0.95);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            width: 90%; max-width: 380px; left: 5%;
            overflow: hidden;
        }
        #toast-notification::before {
            content: ''; position: absolute; inset: 0;
            border-radius: 12px; padding: 1px;
            background: linear-gradient(90deg, rgba(255,255,255,0.1), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            pointer-events: none;
        }
        @media (min-width: 768px) { #toast-notification { width: auto; left: auto; right: 20px; } }
        #toast-notification.show { transform: translateY(0); }

        #toast-notification.error-toast { border-left-color: #ef4444; }
        #toast-notification.success-toast { border-left-color: #10b981; }

        /* Status Modal */
        .status-modal-overlay {
            position: fixed; inset: 0; background: rgba(3, 7, 18, 0.85); backdrop-filter: blur(8px);
            z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .status-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .status-modal-content {
            width: 95%; max-width: 800px; max-height: 85vh; overflow-y: hidden; background: rgba(10, 10, 15, 0.9);
            border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column;
        }
        .status-modal-overlay.active .status-modal-content { transform: scale(1); }
        .modal-scroll-area::-webkit-scrollbar { width: 6px; }
        .modal-scroll-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .modal-scroll-area::-webkit-scrollbar-thumb { background: rgba(6, 182, 212, 0.3); border-radius: 3px; }

        /* Filter Styles */
        .modal-filter-select {
            appearance: none;
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            font-size: 0.75rem;
            border-radius: 6px;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .modal-filter-select:hover {
            border-color: rgba(6, 182, 212, 0.5);
            color: #fff;
        }
        .modal-filter-select:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 1px rgba(6, 182, 212, 0.2);
        }

        /* Flatpickr Overrides */
        .flatpickr-calendar {
            background: rgba(3, 7, 18, 0.95) !important; backdrop-filter: blur(25px) !important;
            border: 1px solid rgba(6, 182, 212, 0.5) !important; box-shadow: 0 0 40px rgba(6, 182, 212, 0.15), inset 0 0 20px rgba(6, 182, 212, 0.05) !important;
            border-radius: 4px !important; font-family: 'JetBrains Mono', monospace !important; padding: 10px !important; width: 100% !important; max-width: 340px !important;
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)) !important;
            background-size: 100% 2px, 3px 100% !important;
        }
        .flatpickr-days { width: 100% !important; }
        .dayContainer { width: 100% !important; min-width: 0 !important; max-width: none !important; justify-content: flex-start !important; }
        .flatpickr-prev-month, .flatpickr-next-month { display: none !important; }
        .flatpickr-current-month { text-transform: uppercase; letter-spacing: 2px; color: #06b6d4 !important; font-weight: 800 !important; padding-top: 5px; width: 100% !important; left: 0 !important; pointer-events: none !important; }
        .flatpickr-monthDropdown-months, .flatpickr-current-month input.cur-year { background: transparent !important; border: none !important; box-shadow: none !important; color: inherit !important; font-weight: inherit !important; appearance: none !important; -webkit-appearance: none !important; pointer-events: none !important; }
        .numInputWrapper span { display: none !important; }
        .flatpickr-weekdays { background: transparent !important; border-bottom: 1px solid rgba(6, 182, 212, 0.3) !important; margin-bottom: 10px !important; }
        .flatpickr-day { border-radius: 2px !important; border: 1px solid rgba(255,255,255,0.05) !important; color: #cbd5e1 !important; transition: all 0.1s !important; margin: 0 !important; height: 38px !important; line-height: 38px !important; flex-basis: 14.2857% !important; max-width: 14.2857% !important; box-sizing: border-box !important; }
        .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { visibility: hidden !important; pointer-events: none !important; }
        .flatpickr-day:hover { background: rgba(6, 182, 212, 0.2) !important; border-color: rgba(6, 182, 212, 0.8) !important; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4) !important; transform: scale(1.1); z-index: 10; }
        .flatpickr-day.selected { background: #06b6d4 !important; border: 1px solid #fff !important; box-shadow: 0 0 20px rgba(6, 182, 212, 0.8) !important; color: #000 !important; font-weight: 900 !important; animation: pulse-select 1.5s infinite; }
        .flatpickr-day.flatpickr-disabled { opacity: 0.1 !important; cursor: not-allowed !important; border: none !important; }
        .flatpickr-day.already-filled-date { background: rgba(16, 185, 129, 0.15) !important; border: 1px solid rgba(16, 185, 129, 0.5) !important; color: #34d399 !important; box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.2); }
        .flatpickr-day.already-filled-date::after { content: '✓'; position: absolute; top: 2px; right: 2px; font-size: 8px; color: #34d399; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        textarea::-webkit-scrollbar { width: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #1e293b; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-3 md:p-6 selection:bg-cyan-500 selection:text-black">

<!-- Starfield & Ambient -->
<canvas id="starfield" class="fixed inset-0 w-full h-full z-[-2]"></canvas>
<div class="ambient-light"></div>
<canvas id="confetti-canvas"></canvas>

<!-- FULL SCREEN LOADER OVERLAY -->
<div id="global-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 hidden">
    <div class="relative">
        <!-- Pulse Ring -->
        <div class="absolute inset-0 rounded-full animate-ping opacity-25 bg-cyan-500"></div>
        <!-- Loader Spinner -->
        <div class="loader-ring relative z-10"></div>
    </div>
    <p id="loader-text" class="mt-6 text-cyan-400 font-mono text-sm tracking-[0.3em] uppercase animate-pulse font-bold">Initializing...</p>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="fixed top-6 z-[90] flex items-center gap-4 px-4 py-4">
    <div id="toast-icon" class="text-2xl flex-shrink-0"></div>
    <div>
        <h4 id="toast-title" class="text-xs font-bold uppercase tracking-widest text-cyan-400 mb-1">System Message</h4>
        <p id="toast-message" class="text-sm font-medium text-slate-200 leading-snug"></p>
    </div>
</div>

<!-- ================= LOGIN VIEW (GATEKEEPER) ================= -->
<section id="login-view">
    <!-- Moving Cyber Grid Background -->
    <div class="cyber-grid"></div>

    <div class="login-card flex flex-col items-center">
        <!-- Laser Scanner Element -->
        <div class="login-scanner"></div>

        <!-- Tech Corner Accents -->
        <div class="corner-accent tl"></div>
        <div class="corner-accent tr"></div>
        <div class="corner-accent bl"></div>
        <div class="corner-accent br"></div>

        <!-- Biometric Icon -->
        <div class="w-24 h-24 rounded-full bg-cyan-900/10 flex items-center justify-center mb-8 ring-1 ring-cyan-500/30 shadow-[0_0_50px_rgba(6,182,212,0.15)] relative">
            <svg class="w-12 h-12 text-cyan-400 z-10 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <!-- Orbiting rings -->
            <div class="absolute inset-0 border border-cyan-500/20 rounded-full animate-[spin_10s_linear_infinite]"></div>
            <div class="absolute inset-2 border border-dashed border-cyan-500/30 rounded-full animate-[spin_15s_linear_infinite_reverse]"></div>
        </div>

        <h1 class="text-4xl font-black text-white tracking-tighter mb-2 uppercase font-sans text-center">Identity <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-violet-500">Verification</span></h1>
        <p class="text-[10px] text-slate-400 mb-10 font-mono tracking-[0.3em] uppercase opacity-70 text-center">Secure Terminal Access v2.2</p>

        <div class="w-full">
            <div class="login-input-group">
                <label for="login-emp-id" class="text-[9px] uppercase text-cyan-500 font-bold tracking-widest mb-2 block text-center opacity-80">Employee Identifier</label>
                <!-- Default Value set to A- -->
                <input type="text" id="login-emp-id" class="login-input" value="A-" maxlength="7" spellcheck="false" aria-label="Employee ID Input" autocomplete="username">
                <p id="login-helper" class="text-[10px] text-slate-500 text-center font-mono mt-2 h-4 tracking-wider transition-colors duration-300">FORMAT: A-XXXXX</p>
            </div>

            <button id="login-btn" class="btn-premium w-full py-5 rounded-xl text-sm shadow-xl" disabled aria-label="Authenticate Access">
                Authenticate Access
            </button>
        </div>
    </div>
</section>


<!-- ================= DASHBOARD VIEW (INITIALLY HIDDEN) ================= -->
<main id="dashboard-view" class="pro-card rounded-2xl md:rounded-3xl p-6 md:p-12 z-10 mx-auto">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 md:mb-10 border-b border-white/5 pb-6">
        <div class="w-full md:w-auto">
            <div class="flex flex-wrap items-center gap-2 mb-2">
                <span class="h-2 w-2 rounded-full bg-cyan-400 animate-pulse"></span>
                <span class="text-xs font-mono text-cyan-400 uppercase tracking-widest">Workspace v2.3 <span class="text-slate-600 mx-1">|</span> <span id="live-clock" class="text-slate-400 whitespace-nowrap">00:00:00</span></span>
            </div>
            <!-- Responsive Title Size -->
            <h2 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tighter text-white leading-tight">
                <span id="header-first-name">BISWAJIT</span> <span id="header-last-name" class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-violet-500">SAHOO</span>
            </h2>
            <p class="text-sm md:text-base text-slate-400 mt-1 font-light tracking-wide flex items-center gap-2">
                Daily Engineering Progress Log
                <span class="px-2 py-0.5 rounded bg-white/10 text-white text-[10px] font-mono" id="header-emp-id">A-22169</span>
            </p>
        </div>

        <div class="mt-4 md:mt-0 w-full md:w-auto flex flex-col items-end gap-3">
            <div class="flex gap-2">
                <!-- Status Button -->
                <button id="get-status-btn" class="btn-status w-full md:w-auto justify-center" aria-label="View Status Log">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    VIEW STATUS
                </button>

                <!-- Logout Button (NEW) -->
                <button id="logout-btn" class="btn-logout" title="Secure Logout" aria-label="Logout">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>

            <button id="manual-trigger-btn" class="w-full md:w-auto group flex items-center justify-center md:justify-start gap-3 px-4 py-2 rounded-lg bg-black/40 border border-white/10 hover:border-cyan-500/50 transition-all cursor-pointer" aria-label="Trigger N8N Engine">
                <div class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <div class="absolute inset-0 bg-green-500 rounded-full animate-ping opacity-75"></div>
                </div>
                <div class="flex flex-col text-left">
                    <span class="text-[10px] uppercase text-slate-500 font-bold group-hover:text-cyan-400 transition-colors">N8N Engine</span>
                    <span class="text-xs font-mono text-white">Online</span>
                </div>
            </button>
        </div>
    </header>

    <!-- Form -->
    <form id="log-form" class="space-y-6 md:space-y-8" onsubmit="return false;">

        <!-- Meta Data Grid -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
            <!-- Log ID -->
            <div class="md:col-span-3">
                <label for="si_no" class="pro-label">Log Sequence</label>
                <input type="number" id="si_no" name="si_no" class="pro-input w-full p-3 md:p-3 rounded-lg text-center font-bold text-lg text-cyan-400 focus:text-cyan-300" readonly placeholder="--" aria-label="Log Sequence Number">
            </div>
            <!-- Date -->
            <div class="md:col-span-9">
                <label for="date" class="pro-label">Date Entry</label>
                <div class="relative group">
                    <input type="text" id="date" name="date" class="pro-input w-full p-3 md:p-3 rounded-lg pl-12 cursor-pointer text-slate-300 group-hover:text-cyan-300 transition-colors" placeholder="YYYY-MM-DD" required aria-label="Select Date">
                </div>
            </div>
        </div>

        <!-- Work Report Section -->
        <div class="relative group">
            <div class="flex flex-row justify-between items-center mb-2">
                <label for="work_done" class="pro-label text-cyan-400">Activity Report</label>

                <div class="flex gap-2">
                    <!-- COPY BUTTON -->
                    <button type="button" id="copy-report-btn" class="btn-icon-action" title="Copy to Clipboard" aria-label="Copy Activity Report">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>

                    <!-- VOICE BUTTON (NEW) -->
                    <button type="button" id="voice-record-btn" class="btn-icon-action group relative" title="Voice Dictation" aria-label="Record Voice">
                        <!-- Standard Mic -->
                        <svg id="mic-icon" class="w-4 h-4 transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                        <!-- Loader / Stop Icon (Hidden initially) -->
                        <div id="mic-loader" class="hidden absolute inset-0 items-center justify-center">
                            <svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>
                    </button>

                    <!-- NEW AI Button Design -->
                    <button type="button" id="gemini-suggest-btn" class="btn-ai-new" aria-label="AI Enhancement">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span>AI Polish</span>
                    </button>
                </div>
            </div>

            <div class="relative">
                <!-- Reduced rows from 6 to 3 for smaller height -->
                <textarea id="work_done" name="work_done" rows="3"
                          class="pro-input w-full p-4 rounded-lg leading-relaxed text-slate-300 focus:text-white resize-none"
                          placeholder="Detail your tasks, bugs fixed, or features implemented... (Tip: Press Ctrl+Enter to submit)" required aria-label="Activity Report Content"></textarea>

                <!-- Decorative accents -->
                <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-500 pointer-events-none opacity-50"></div>
                <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-500 pointer-events-none opacity-50"></div>
            </div>

            <!-- Quick Task Chips -->
            <div class="flex flex-wrap gap-2 mt-3 items-center">
                <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold mr-1 hidden xs:inline">Quick Add:</span>
                <button type="button" class="chip" onclick="addText('Daily Scrum')">Scrum</button>
                <button type="button" class="chip" onclick="addText('Bug Fixes:')">Fixes</button>
                <button type="button" class="chip" onclick="addText('Code Review')">Review</button>
                <button type="button" class="chip" onclick="addText('Feature Dev:')">Feature</button>
                <button type="button" class="chip" onclick="addText('Docs Update')">Docs</button>
            </div>

            <div class="text-right mt-1">
                <span id="save-status" class="text-[10px] text-cyan-500/70 font-mono tracking-widest uppercase opacity-0 transition-opacity">Saved locally</span>
            </div>
        </div>

        <!-- Timing Control Panel -->
        <div class="bg-black/20 rounded-2xl p-4 md:p-6 border border-white/5 relative overflow-hidden">
            <!-- Background grid for tech feel -->
            <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>

            <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6 md:gap-8 items-center relative z-10">

                <!-- Start -->
                <div class="order-1 md:order-none">
                    <label for="in_time" class="pro-label">Clock In</label>
                    <input type="time" id="in_time" name="in_time" class="pro-input w-full p-4 rounded-lg text-center text-xl font-mono tracking-widest text-cyan-300" required aria-label="Start Time">
                </div>

                <!-- NEW PENTAGON GAUGE -->
                <div class="flex flex-col items-center justify-center relative order-2 md:order-none my-2 md:my-0">
                    <div class="widget-gauge-wrapper group cursor-default">
                        <div class="widget-gauge-bg"></div>
                        <div class="widget-gauge-pentagon">
                            <div class="pentagon-ring"></div>
                            <div id="duration-content" class="widget-content flex flex-col items-center z-10">
                                <span class="text-lg font-bold text-white font-mono">--</span>
                            </div>
                        </div>
                    </div>
                    <span class="absolute -bottom-6 text-[9px] uppercase tracking-[0.2em] text-slate-500 font-bold">Duration</span>
                </div>

                <!-- End -->
                <div class="order-3 md:order-none">
                    <label for="out_time" class="pro-label">Clock Out</label>
                    <input type="time" id="out_time" name="out_time" class="pro-input w-full p-4 rounded-lg text-center text-xl font-mono tracking-widest text-violet-300" required aria-label="End Time">
                </div>
            </div>
        </div>

        <!-- Action Area -->
        <div class="pt-2 md:pt-4">
            <button type="submit" id="submit-btn" class="btn-primary w-full py-4 md:py-5 rounded-lg font-black text-white text-lg shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95" disabled aria-label="Transmit Report">
                <span>TRANSMIT REPORT</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>

    </form>
</main>

<footer class="fixed bottom-4 left-4 text-[10px] text-slate-600 font-mono tracking-widest pointer-events-none hidden md:block">
    SECURE CONNECTION ESTABLISHED • N8N PROTOCOL ACTIVE
</footer>

<!-- STATUS MODAL COMPONENT -->
<div id="status-modal" class="status-modal-overlay">
    <div class="status-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-white/10 bg-black/40">
            <div>
                <h2 class="text-xl font-bold text-white tracking-tight">DSR STATUS LOG</h2>
                <p class="text-xs text-slate-400 font-mono mt-1">Employee ID: <span class="text-cyan-400" id="modal-emp-id">--</span></p>
            </div>
            <button id="close-modal-btn" class="text-slate-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/5" aria-label="Close Modal">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Filter Controls -->
        <div class="flex flex-wrap items-center gap-3 px-4 md:px-6 py-4 border-b border-white/5 bg-white/[0.02]">
            <div class="flex-grow sm:flex-grow-0 min-w-[140px]">
                <label for="filter-status" class="sr-only">Filter by Status</label>
                <select id="filter-status" class="modal-filter-select w-full" aria-label="Filter by Status">
                    <option value="all">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="not filled">Not Filled</option>
                </select>
            </div>
            <div class="flex-grow sm:flex-grow-0 min-w-[140px]">
                <label for="filter-hours" class="sr-only">Filter by Hours</label>
                <select id="filter-hours" class="modal-filter-select w-full" aria-label="Filter by Hours">
                    <option value="all">All Hours</option>
                    <!-- JS Populates this -->
                </select>
            </div>

            <button id="clear-filters-btn" class="group px-3 py-2 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500/30 text-slate-400 hover:text-cyan-400 text-xs font-bold uppercase tracking-wider transition-all ml-auto sm:ml-0 whitespace-nowrap flex items-center gap-2" title="Reset Filters" aria-label="Clear Filters">
                <svg class="w-3 h-3 group-hover:rotate-90 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Clear
            </button>
        </div>

        <!-- Table Content -->
        <div class="flex-1 overflow-auto modal-scroll-area p-0">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-[#0a0a0f] z-10 shadow-lg">
                <tr>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-white/10">Date</th>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-white/10">Logged Hours</th>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-white/10 text-right">Current Status</th>
                </tr>
                </thead>
                <tbody id="status-table-body" class="text-sm">
                <tr>
                    <td colspan="3" class="p-8 text-center text-slate-500 animate-pulse">Loading data records...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Modal Footer -->
        <div class="p-4 border-t border-white/10 bg-black/40 text-center">
            <p class="text-[10px] text-slate-600 font-mono">CONFIDENTIAL DATA • DO NOT SHARE</p>
        </div>
    </div>
</div>

<!-- LOGIC SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // --- Live Clock ---
    setInterval(() => {
        const now = new Date();
        document.getElementById('live-clock').textContent = now.toLocaleTimeString('en-US', {hour12: false});
    }, 1000);

    // --- Global State ---
    let currentUser = {
        id: "",
        name: ""
    };

    // Cache for modal data to enable local filtering
    let statusDataCache = [];

    // --- Loader Functions ---
    const globalLoader = document.getElementById('global-loader');
    const loaderText = document.getElementById('loader-text');

    function showLoader(msg = "PROCESSING...") {
        loaderText.textContent = msg;
        globalLoader.classList.remove('hidden');
        // Force reflow
        void globalLoader.offsetWidth;
        globalLoader.style.opacity = '1';
        globalLoader.style.visibility = 'visible';
    }

    function hideLoader() {
        globalLoader.style.opacity = '0';
        globalLoader.style.visibility = 'hidden';
        setTimeout(() => {
            globalLoader.classList.add('hidden');
        }, 300);
    }

    // --- Toast Functions ---
    const toastEl = document.getElementById('toast-notification');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    function showMessage(msg, isError = false) {
        toastMessage.textContent = msg;

        // Reset classes
        toastEl.classList.remove('error-toast', 'success-toast');
        toastTitle.classList.remove('text-cyan-400', 'text-red-400', 'text-emerald-400');

        if (isError) {
            toastIcon.innerHTML = '⚠️';
            toastEl.classList.add('error-toast');
            toastTitle.textContent = "SYSTEM ALERT";
            toastTitle.classList.add('text-red-400');
        } else {
            toastIcon.innerHTML = '✅';
            toastEl.classList.add('success-toast');
            toastTitle.textContent = "SUCCESS";
            toastTitle.classList.add('text-emerald-400');
        }

        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 4000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. VISUAL EFFECTS ---
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        const stars = [];
        const numStars = window.innerWidth < 600 ? 150 : 300;

        const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Star {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 1.5;
                this.speed = Math.random() * 0.2 + 0.05;
                this.alpha = Math.random();
            }
            update() {
                this.y -= this.speed;
                if (this.y < 0) this.reset();
            }
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }
        for(let i=0; i<numStars; i++) stars.push(new Star());
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => { star.update(); star.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // --- Confetti Effect ---
        const cCanvas = document.getElementById('confetti-canvas');
        const cCtx = cCanvas.getContext('2d');
        let confetti = [];
        function resizeConfetti() { cCanvas.width = window.innerWidth; cCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeConfetti);
        resizeConfetti();

        function fireConfetti() {
            confetti = [];
            for(let i=0; i<100; i++) {
                confetti.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    color: `hsl(${Math.random()*360}, 100%, 50%)`,
                    life: 100
                });
            }
            animateConfetti();
        }
        function animateConfetti() {
            cCtx.clearRect(0, 0, cCanvas.width, cCanvas.height);
            confetti.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--;
                cCtx.fillStyle = p.color; cCtx.fillRect(p.x, p.y, 5, 5);
                if(p.life <= 0) confetti.splice(i, 1);
            });
            if(confetti.length > 0) requestAnimationFrame(animateConfetti);
        }

        // --- 2. CONFIG & VARIABLES ---
        const N8N_REWRITE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/AI_GenerateWorkDone";
        const N8N_SUBMIT_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/submitButton";
        const N8N_DATE_FILL_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/dateFill";
        const N8N_EDIT_WORK_DONE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/editWorkDone";
        const N8N_MANUAL_TRIGGER_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/manualTrigger";
        const N8N_GET_STATUS_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/GetDsrStatusDetails";
        const N8N_GET_EMP_NAME_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/GetEmpName";
        const N8N_VOICE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/voice";

        const logForm = document.getElementById('log-form');
        const submitBtn = document.getElementById('submit-btn');
        const workDoneTextarea = document.getElementById('work_done');
        const suggestBtn = document.getElementById('gemini-suggest-btn');
        const manualTriggerBtn = document.getElementById('manual-trigger-btn');
        const siNoInput = document.getElementById('si_no');
        const dateInput = document.getElementById('date');
        const inTimeInput = document.getElementById('in_time');
        const outTimeInput = document.getElementById('out_time');
        const durationContent = document.getElementById('duration-content');
        const saveStatusEl = document.getElementById('save-status');

        // Views
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');

        // Login Elements
        const loginEmpIdInput = document.getElementById('login-emp-id');
        const loginBtn = document.getElementById('login-btn');
        const loginHelper = document.getElementById('login-helper');

        // Header Elements
        const headerFirstName = document.getElementById('header-first-name');
        const headerLastName = document.getElementById('header-last-name');
        const headerEmpId = document.getElementById('header-emp-id');
        const modalEmpId = document.getElementById('modal-emp-id');
        const logoutBtn = document.getElementById('logout-btn');

        // Modal Elements
        const statusModal = document.getElementById('status-modal');
        const getStatusBtn = document.getElementById('get-status-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const statusTableBody = document.getElementById('status-table-body');
        const filterStatus = document.getElementById('filter-status');
        const filterHours = document.getElementById('filter-hours');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        // Copy Elements
        const copyReportBtn = document.getElementById('copy-report-btn');

        // Voice Elements
        const voiceBtn = document.getElementById('voice-record-btn');
        const micIcon = document.getElementById('mic-icon');
        const micLoader = document.getElementById('mic-loader');
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        let filledDays = [];

        async function fetchWithExponentialBackoff(url, options, retries = 4, delay = 1000) {
            try { return await fetch(url, options); }
            catch (error) {
                if (retries > 0) { await new Promise(resolve => setTimeout(resolve, delay)); return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2); }
                else { throw error; }
            }
        }

        // --- 4. LOGIN LOGIC ---
        // Force prefix logic
        loginEmpIdInput.addEventListener('keydown', (e) => {
             if (loginEmpIdInput.selectionStart < 2 && (e.key === 'Backspace' || e.key === 'Delete')) {
                 e.preventDefault();
             }
             if (loginEmpIdInput.selectionStart < 2 && e.key === 'ArrowLeft') {
                 e.preventDefault();
             }
        });

        loginEmpIdInput.addEventListener('click', () => {
             if (loginEmpIdInput.selectionStart < 2) {
                 loginEmpIdInput.setSelectionRange(2, 2);
             }
        });

        loginEmpIdInput.addEventListener('input', (e) => {
            let val = e.target.value.toUpperCase();

            if (!val.startsWith('A-')) {
                val = 'A-' + val.replace(/^A-?/, '');
            }

            const prefix = val.substring(0, 2);
            const rest = val.substring(2).replace(/[^0-9]/g, '');
            e.target.value = prefix + rest;

            const regex = /^A-\d{5}$/;
            const isValid = regex.test(e.target.value);

            if (isValid) {
                loginBtn.disabled = false;
                loginHelper.textContent = "✓ ID PATTERN RECOGNIZED";
                loginHelper.className = "text-[10px] text-emerald-400 text-center font-mono mt-2 h-4 tracking-wider transition-colors duration-300 font-bold";
                loginEmpIdInput.classList.remove('error');
                loginEmpIdInput.style.borderColor = "#34d399";
                loginEmpIdInput.style.boxShadow = "0 0 15px rgba(52, 211, 153, 0.3)";
            } else {
                loginBtn.disabled = true;
                loginHelper.textContent = "FORMAT: A-XXXXX (5 DIGITS)";
                loginHelper.className = "text-[10px] text-slate-500 text-center font-mono mt-2 h-4 tracking-wider transition-colors duration-300";

                if (e.target.value.length === 7) {
                     loginEmpIdInput.classList.add('error');
                     setTimeout(() => loginEmpIdInput.classList.remove('error'), 400);
                } else {
                    loginEmpIdInput.classList.remove('error');
                    loginEmpIdInput.style.borderColor = "rgba(255, 255, 255, 0.1)";
                    loginEmpIdInput.style.boxShadow = "none";
                }
            }
        });

        loginBtn.addEventListener('click', async () => {
            const empId = loginEmpIdInput.value;
            if (!empId) return;

            showLoader("AUTHENTICATING IDENTITY...");

            try {
                const response = await fetchWithExponentialBackoff(`${N8N_GET_EMP_NAME_URL}?empID=${empId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error("Failed to parse JSON response");
                }

                if (data && (data.status === "error" || data.message)) {
                    showMessage(data.message || "Employee is not registered. Please register.", true);
                    loginEmpIdInput.classList.add('error');
                    setTimeout(() => loginEmpIdInput.classList.remove('error'), 400);
                } else if (data && data.EmpName) {
                        // Success Logic
                        currentUser.id = data.EmpID;
                        currentUser.name = data.EmpName;

                        // Parse Name
                        const nameParts = data.EmpName.split(' ');
                        const firstName = nameParts[0];
                        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

                        // Update DOM
                        headerFirstName.textContent = firstName;
                        headerLastName.textContent = lastName;
                        headerEmpId.textContent = currentUser.id;
                        modalEmpId.textContent = currentUser.id;
                        document.title = `${firstName} ${lastName} | Workspace`;

                        // Transition
                        loginView.classList.add('hidden');

                        dashboardView.style.display = '';
                        dashboardView.classList.add('active');

                        initializeDateTime();
                    } else {
                        showMessage("Unexpected API response", true);
                    }
            } catch (error) {
                console.error(error);
                showMessage("System Offline. Check Connection.", true);
            } finally {
                hideLoader();
            }
        });

        // --- DASHBOARD FUNCTIONS ---
        logoutBtn.addEventListener('click', () => {
            dashboardView.classList.remove('active');

            setTimeout(() => {
                dashboardView.style.display = 'none';
                loginView.classList.remove('hidden');

                // Reset State
                currentUser = { id: "", name: "" };
                logForm.reset();
                loginEmpIdInput.value = "A-";
                loginBtn.disabled = true;
                loginHelper.textContent = "FORMAT: A-XXXXX";
                loginHelper.className = "text-[10px] text-slate-500 text-center font-mono mt-2 h-4 tracking-wider transition-colors duration-300";

                document.title = "Workspace | Secure Access";
            }, 500);
        });

        copyReportBtn.addEventListener('click', () => {
            const text = workDoneTextarea.value;
            if (!text) {
                showMessage("Nothing to copy!", true);
                return;
            }

            workDoneTextarea.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();

            showMessage("Copied to Clipboard!");
        });

        // --- VOICE RECORDING LOGIC ---
        voiceBtn.addEventListener('click', async () => {
            if (!isRecording) {
                // START RECORDING
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.start();
                    isRecording = true;

                    // UI Updates
                    voiceBtn.classList.add('recording');
                    voiceBtn.title = "Stop Recording";
                    micIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />`; // Stop Icon
                    showMessage("Recording... Click to stop.");

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        // PROCESSING START
                        isRecording = false;
                        const stream = mediaRecorder.stream;
                        stream.getTracks().forEach(track => track.stop());

                        // UI Loading
                        voiceBtn.classList.remove('recording');
                        voiceBtn.disabled = true;
                        micIcon.classList.add('hidden');
                        micLoader.classList.remove('hidden');
                        micLoader.classList.add('flex');

                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const formData = new FormData();
                        // Important: N8N/Curl example used 'data' as the field name and a filename
                        formData.append('data', audioBlob, 'recording.wav');

                        try {
                            const response = await fetch(N8N_VOICE_URL, {
                                method: 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data && data["Voice Text"]) {
                                    const newText = data["Voice Text"];
                                    const currentText = workDoneTextarea.value;
                                    // Append logic
                                    if (currentText.trim() === "") {
                                        workDoneTextarea.value = newText;
                                    } else {
                                        workDoneTextarea.value = currentText + "\n- " + newText;
                                    }
                                    saveToLocal();
                                    checkFormValidity();
                                    showMessage("Voice transcribed successfully.");
                                } else {
                                    showMessage("No speech detected.", true);
                                }
                            } else {
                                showMessage("Voice API Error.", true);
                            }
                        } catch (err) {
                            console.error(err);
                            showMessage("Connection Failed.", true);
                        } finally {
                            // RESET UI
                            voiceBtn.disabled = false;
                            voiceBtn.title = "Voice Dictation";
                            micIcon.classList.remove('hidden');
                            micLoader.classList.add('hidden');
                            micLoader.classList.remove('flex');
                            micIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />`; // Mic Icon
                        }
                    };

                } catch (err) {
                    console.error("Mic Error:", err);
                    showMessage("Microphone access denied.", true);
                }
            } else {
                // STOP RECORDING
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    // State changes happen in onstop event
                }
            }
        });

        window.addText = function(text) {
            const textarea = document.getElementById('work_done');
            if (textarea.value.length > 0) {
                textarea.value += '\n- ' + text + ' ';
            } else {
                textarea.value = '- ' + text + ' ';
            }
            textarea.dispatchEvent(new Event('input'));
            textarea.focus();
        };

        function formatTimeForN8N(time24h) {
            if (!time24h) return '';
            const [hours, minutes] = time24h.split(':').map(Number);
            let h = hours; const m = String(minutes).padStart(2, '0'); let modifier = 'AM';
            if (h === 0) h = 12; else if (h === 12) modifier = 'PM'; else if (h > 12) { h = h - 12; modifier = 'PM'; }
            return `${h}:${m} ${modifier}`;
        }

        function convert12hTo24h(timeStr) {
            if (!timeStr) return '';
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!match) return '';
            let [_, hours, minutes, modifier] = match; hours = parseInt(hours, 10);
            if (hours === 12 && modifier.toUpperCase() === 'AM') hours = 0; else if (hours !== 12 && modifier.toUpperCase() === 'PM') hours += 12;
            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        function calculateEndTime(startTime24h) {
            if (!startTime24h) return '';
            const [startHour, startMinute] = startTime24h.split(':').map(Number);
            const shiftHours = 9; const shiftMinutes = 5;
            let endMinute = startMinute + shiftMinutes; let carryHour = 0;
            if (endMinute >= 60) { endMinute -= 60; carryHour = 1; }
            let endHour = startHour + shiftHours + carryHour;
            if (endHour >= 24) endHour %= 24;
            return `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
        }

        workDoneTextarea.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!submitBtn.disabled) { logForm.dispatchEvent(new Event('submit')); }
                else { showMessage("Please fill all fields first", true); }
            }
        });

        function saveToLocal() {
            localStorage.setItem('dailyLog_draft', workDoneTextarea.value);
            saveStatusEl.style.opacity = '1';
            setTimeout(() => saveStatusEl.style.opacity = '0', 2000);
        }
        const savedDraft = localStorage.getItem('dailyLog_draft');
        if(savedDraft && !workDoneTextarea.value) { workDoneTextarea.value = savedDraft; }
        workDoneTextarea.addEventListener('input', () => { saveToLocal(); checkFormValidity(); });

        async function fetchFilledDates(instance) {
            try {
                const response = await fetchWithExponentialBackoff(N8N_DATE_FILL_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data && Array.isArray(data.AlreadyFieldDate)) {
                        filledDays = data.AlreadyFieldDate.map(d => Number(d));
                        if (instance) instance.redraw();
                    }
                }
            } catch (error) { console.error("Date fetch error", error); }
        }

        async function fetchWorkDoneForDate(dayNumber) {
            showLoader("SYNCING DATABASE...");
            try {
                const response = await fetchWithExponentialBackoff(N8N_EDIT_WORK_DONE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ "preFieldDate": String(dayNumber) })
                });
                if (response.ok) {
                    const data = await response.json();
                    const record = data.PreFieldValueBasedOnDate;
                    if (record) {
                        if (record["SI No"]) siNoInput.value = record["SI No"];
                        if (record["WorkDone"] && record["WorkDone"].trim() !== "") {
                            workDoneTextarea.value = record["WorkDone"];
                            if (record["InTime"]) inTimeInput.value = convert12hTo24h(record["InTime"]);
                            if (record["OutTime"]) outTimeInput.value = convert12hTo24h(record["OutTime"]);
                            showMessage("Entry loaded.");
                        } else {
                            workDoneTextarea.value = "";
                            setDefaultTimes();
                        }
                        updateDurationDisplay(); checkFormValidity();
                    }
                }
            } catch (error) { showMessage("Sync failed.", true); }
            finally { hideLoader(); }
        }

        // --- FLATPICKR CONFIG ---
        const fp = flatpickr("#date", {
            dateFormat: "Y-m-d",
            theme: "dark",
            disableMobile: true,
            maxDate: "today",
            minDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
            onOpen: (selectedDates, dateStr, instance) => {
                fetchFilledDates(instance);
            },
            onDayCreate: (dObj, dStr, fp, dayElem) => {
                if (dayElem.classList.contains("prevMonthDay") || dayElem.classList.contains("nextMonthDay")) return;
                const dayNumber = dayElem.dateObj.getDate();
                if (filledDays.includes(dayNumber)) {
                    dayElem.classList.add("already-filled-date");
                }
            },
            onChange: (selectedDates, dateStr, instance) => {
                dateInput.value = dateStr;
                dateInput.dispatchEvent(new Event('input'));
                if (selectedDates.length > 0) fetchWorkDoneForDate(selectedDates[0].getDate());
            }
        });

        function updateDurationDisplay() {
            const startVal = inTimeInput.value; const endVal = outTimeInput.value;
            if (!startVal || !endVal) { durationContent.innerHTML = `<span class="text-2xl font-bold text-slate-500">--</span>`; return; }
            const [startH, startM] = startVal.split(':').map(Number); const [endH, endM] = endVal.split(':').map(Number);
            let startTotalMins = (startH * 60) + startM; let endTotalMins = (endH * 60) + endM;
            if (endTotalMins < startTotalMins) endTotalMins += (24 * 60);
            const diffMins = endTotalMins - startTotalMins;
            const hours = Math.floor(diffMins / 60); const minutes = diffMins % 60;
            if (minutes === 0) {
                durationContent.innerHTML = `<span class="text-3xl font-black text-white leading-none tracking-tighter">${hours}<span class="text-sm text-cyan-400 align-top ml-1">h</span></span>`;
            } else {
                durationContent.innerHTML = `<div class="flex flex-col leading-none items-center"><span class="text-2xl font-bold text-white tracking-tighter">${hours}<span class="text-[10px] text-cyan-400 ml-0.5">h</span></span><span class="text-sm font-medium text-violet-400 tracking-tighter">${minutes}<span class="text-[8px] ml-0.5">m</span></span></div>`;
            }
        }

        function setDefaultTimes() {
            const today = new Date();
            const h = String(today.getHours()).padStart(2, '0'); const m = String(today.getMinutes()).padStart(2, '0');
            const time = `${h}:${m}`; inTimeInput.value = time; outTimeInput.value = calculateEndTime(time);
        }

        function initializeDateTime() {
            const today = new Date();
            const y = today.getFullYear(); const m = String(today.getMonth() + 1).padStart(2, '0'); const d = String(today.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;
            fp.setDate(dateStr); siNoInput.value = d; setDefaultTimes(); updateDurationDisplay();
            fetchFilledDates(null);
        }

        function checkFormValidity() {
            const isValid = siNoInput.value.trim() !== '' && dateInput.value.trim() !== '' && workDoneTextarea.value.trim() !== '' && inTimeInput.value.trim() !== '' && outTimeInput.value.trim() !== '';
            submitBtn.disabled = !isValid;
            if(isValid) { submitBtn.classList.add('brightness-110'); } else { submitBtn.classList.remove('brightness-110'); }
        }

        // --- STATUS LOGIC ---
        function getStatusStyling(statusText) {
            const status = statusText ? statusText.toLowerCase() : "";
            if (status.includes("pending")) {
                return "bg-yellow-400 text-black border-yellow-500 shadow-[0_0_10px_rgba(250,204,21,0.4)]";
            }
            else if (status.includes("approved")) {
                return "bg-emerald-400 text-black border-emerald-500 shadow-[0_0_10px_rgba(52,211,153,0.4)]";
            }
            else {
                return "bg-slate-200 text-black border-slate-300";
            }
        }

        function renderStatusTable(data) {
            statusTableBody.innerHTML = '';

            if (data.length === 0) {
                statusTableBody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-500">No records match your filter.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const badgeClass = getStatusStyling(item.status);

                const row = document.createElement('tr');
                row.className = 'border-b border-white/5 hover:bg-white/5 transition-colors group';

                row.innerHTML = `
                    <td class="p-4 font-mono text-slate-300 group-hover:text-white transition-colors">
                        ${item.date}
                    </td>
                    <td class="p-4 font-mono text-cyan-300">
                        ${item.hour}
                    </td>
                    <td class="p-4 text-right">
                        <span class="inline-block px-3 py-1 rounded-md text-[10px] font-black uppercase tracking-wider ${badgeClass}">
                            ${item.status}
                        </span>
                    </td>
                `;
                statusTableBody.appendChild(row);
            });
        }

        function populateHoursFilter(data) {
            const hoursSet = new Set();
            data.forEach(item => {
                if (item.hour) hoursSet.add(item.hour);
            });

            while (filterHours.options.length > 1) {
                filterHours.remove(1);
            }

            const sortedHours = Array.from(hoursSet).sort((a, b) => {
                const numA = parseInt(a) || 0;
                const numB = parseInt(b) || 0;
                return numA - numB;
            });

            sortedHours.forEach(h => {
                const option = document.createElement('option');
                option.value = h;
                option.text = h;
                filterHours.appendChild(option);
            });
        }

        function filterTable() {
            const statusVal = filterStatus.value.toLowerCase();
            const hoursVal = filterHours.value;

            const filteredData = statusDataCache.filter(item => {
                const itemStatus = item.status ? item.status.toLowerCase() : "";
                const statusMatch = statusVal === "all" || itemStatus.includes(statusVal);
                const hoursMatch = hoursVal === "all" || item.hour === hoursVal;
                return statusMatch && hoursMatch;
            });

            renderStatusTable(filteredData);
        }

        async function openStatusModal() {
            showLoader("RETRIEVING LOGS...");
            statusModal.classList.add('active');
            statusTableBody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-cyan-400 animate-pulse font-mono tracking-widest">CONNECTING TO DATABASE...</td></tr>`;

            filterStatus.value = "all";
            filterHours.innerHTML = '<option value="all">All Hours</option>';

            try {
                const queryParam = currentUser.id ? `?empID=${currentUser.id}` : '';

                const response = await fetchWithExponentialBackoff(`${N8N_GET_STATUS_URL}${queryParam}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }
                });

                if(response.ok) {
                    const data = await response.json();

                    if (Array.isArray(data)) {
                        statusDataCache = data;
                        populateHoursFilter(data);
                        renderStatusTable(data);
                    } else {
                        statusTableBody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-red-400">Invalid data format received.</td></tr>`;
                        statusDataCache = [];
                    }
                } else {
                    throw new Error("Network response was not ok");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                statusTableBody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-red-400">Failed to load status records. Check connection.</td></tr>`;
                statusDataCache = [];
            } finally {
                hideLoader();
            }
        }

        function closeStatusModal() {
            statusModal.classList.remove('active');
        }

        getStatusBtn.addEventListener('click', openStatusModal);
        closeModalBtn.addEventListener('click', closeStatusModal);
        statusModal.addEventListener('click', (e) => {
            if (e.target === statusModal) {
                closeStatusModal();
            }
        });

        filterStatus.addEventListener('change', filterTable);
        filterHours.addEventListener('change', filterTable);
        clearFiltersBtn.addEventListener('click', () => {
            filterStatus.value = "all";
            filterHours.value = "all";
            filterTable();
        });

        // --- FORM EVENT LISTENERS ---
        [dateInput, inTimeInput, outTimeInput].forEach(el => {
            el.addEventListener('input', () => {
                if (el === inTimeInput) { outTimeInput.value = calculateEndTime(el.value); }
                if (el === dateInput && el.value) { siNoInput.value = new Date(el.value).getDate(); }
                updateDurationDisplay(); checkFormValidity();
            });
        });

        manualTriggerBtn.addEventListener('click', async () => {
            const statusSpan = manualTriggerBtn.querySelector('span:last-child');
            const originalText = statusSpan.textContent;
            statusSpan.textContent = "PINGING...";
            manualTriggerBtn.classList.add('animate-pulse');
            try {
                await fetchWithExponentialBackoff(N8N_MANUAL_TRIGGER_URL, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } });
                showMessage("Engine Triggered");
            } catch (error) { showMessage("Signal sent (blind)", false); }
            finally { setTimeout(() => { statusSpan.textContent = originalText; manualTriggerBtn.classList.remove('animate-pulse'); }, 1000); }
        });

        suggestBtn.addEventListener('click', async () => {
            const query = workDoneTextarea.value.trim();
            if (!query) return showMessage("Type a rough draft first.", true);

            const originalHTML = suggestBtn.innerHTML;
            suggestBtn.innerHTML = `<svg class="animate-spin h-3 w-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>PROCESSING</span>`;
            suggestBtn.disabled = true;

            try {
                const response = await fetchWithExponentialBackoff(N8N_REWRITE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ keywords: query }) });
                let resultText = "";
                try { const json = await response.json(); resultText = json.rewritten_text || await response.text(); } catch(e) { resultText = await response.text(); }
                if (resultText) { workDoneTextarea.value = resultText.trim(); saveToLocal(); showMessage("Content polished."); }
            } catch (error) { showMessage("AI Service Unavailable", true); }
            finally { suggestBtn.innerHTML = originalHTML; suggestBtn.disabled = false; checkFormValidity(); }
        });

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (submitBtn.disabled) return;
            const [sH, sM] = inTimeInput.value.split(':').map(Number); const [eH, eM] = outTimeInput.value.split(':').map(Number);
            if ((sH % 12 || 12) === (eH % 12 || 12) && Math.abs(sH - eH) !== 0) { return showMessage("Check AM/PM logic.", true); }
            if (sM === eM && sH === eH) { return showMessage("Start and end time cannot be identical.", true); }

            const originalHTML = submitBtn.innerHTML;
            submitBtn.innerHTML = `<span class="animate-pulse">TRANSMITTING...</span>`;
            submitBtn.disabled = true;
            showLoader("TRANSMITTING REPORT...");

            const payload = {
                "Log ID": siNoInput.value,
                "Date": dateInput.value,
                "Daily Status Report": workDoneTextarea.value,
                "StartTime": formatTimeForN8N(inTimeInput.value),
                "EndTime": formatTimeForN8N(outTimeInput.value),
                "EmployeeID": currentUser.id, // Include current user ID
                "submittedAt": new Date().toISOString(),
                "formMode": "web-submission"
            };

            try {
                const response = await fetchWithExponentialBackoff(N8N_SUBMIT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    fireConfetti();
                    showMessage("Report Logged Successfully!");
                    logForm.reset();
                    localStorage.removeItem('dailyLog_draft');
                    initializeDateTime();
                    checkFormValidity();
                } else { throw new Error("API responded with error"); }
            } catch (error) { showMessage("Transmission failed.", true); }
            finally {
                submitBtn.innerHTML = originalHTML;
                if (!submitBtn.disabled) submitBtn.disabled = false;
                hideLoader();
            }
        });

        // Initial setup for form validity
        checkFormValidity();
    });
</script>
</body>
</html>
