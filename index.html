<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biswajit Sahoo | Workspace</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter for UI, JetBrains Mono for Data -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.2)',
                            border: 'rgba(255, 255, 255, 0.08)',
                        },
                        accent: {
                            cyan: '#00f0ff',
                            purple: '#7000ff',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scanline': 'scanline 8s linear infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        scanline: {
                            '0%': { backgroundPosition: '0% 0%' },
                            '100%': { backgroundPosition: '0% 100%' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        }
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE AESTHETICS --- */
        body {
            background-color: #030712;
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; 
        }

        /* Ambient Background blobs */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(6, 182, 212, 0.15), transparent 25%);
            pointer-events: none;
        }

        /* High-End Glass Panel */
        .pro-card {
            background: rgba(10, 10, 15, 0.75);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 
                0 50px 100px -20px rgba(0, 0, 0, 0.7),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Noise Texture */
        .pro-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }

        /* Top Line Gradient */
        .pro-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.5), rgba(139, 92, 246, 0.5), transparent);
        }

        /* --- INPUT FIELDS --- */
        .pro-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px; 
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        /* STRICTLY HIDE NATIVE CALENDAR ICONS */
        .pro-input::-webkit-calendar-picker-indicator {
            display: none !important;
            opacity: 0 !important;
            background: none !important;
            width: 0 !important;
        }

        @media (min-width: 768px) {
            .pro-input {
                font-size: 0.95rem; 
            }
        }

        .pro-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.2);
        }

        /* Valid State (Green tint) */
        .pro-input:not(:placeholder-shown):valid {
            border-color: rgba(16, 185, 129, 0.4);
        }

        .pro-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* --- BUTTONS --- */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        
        .btn-primary:active {
            transform: scale(0.98); 
        }

        .btn-primary:disabled {
            background: #1e293b;
            color: #64748b;
            cursor: not-allowed;
        }

        /* --- NEW AI BUTTON DESIGN --- */
        .btn-ai {
            position: relative;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: #c4b5fd;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 6px 12px; 
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            white-space: nowrap;
        }
        
        @media (min-width: 640px) {
            .btn-ai {
                padding: 6px 16px;
                gap: 8px;
            }
        }

        .btn-ai::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
            transform: skewX(-20deg);
            transition: 0.5s;
        }

        .btn-ai:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.8);
            color: #fff;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            text-shadow: 0 0 8px rgba(139, 92, 246, 0.8);
        }

        .btn-ai:hover::before {
            left: 150%;
            transition: 0.7s;
        }

        /* --- CHIPS --- */
        .chip {
            font-size: 0.7rem; 
            padding: 6px 12px; 
            border-radius: 4px;
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        @media (min-width: 640px) {
            .chip { font-size: 0.75rem; padding: 4px 12px; }
        }
        .chip:hover, .chip:active {
            background: rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.6);
            color: #fff;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        /* --- DURATION WIDGET --- */
        .widget-gauge {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: #030712;
            box-shadow: 
                0 0 30px rgba(0,0,0,0.8),
                inset 0 0 20px rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            margin: 0 auto; 
        }

        .ring-active {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent, #06b6d4, #8b5cf6, transparent);
            animation: spin 3s linear infinite;
            filter: blur(10px);
            opacity: 0.8;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- TOAST --- */
        #toast-notification {
            transform: translateY(-150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(3, 7, 18, 0.95);
            /* Responsive Width */
            width: 90%; 
            max-width: 380px;
            left: 5%; 
        }
        @media (min-width: 768px) {
            #toast-notification {
                width: auto;
                left: auto;
                right: 20px; 
            }
        }
        #toast-notification.show { transform: translateY(0); }
        
        /* --- HOLOGRAPHIC CALENDAR V3 (Responsive & Locked) --- */
        .flatpickr-calendar {
            background: rgba(3, 7, 18, 0.95) !important;
            backdrop-filter: blur(25px) !important;
            border: 1px solid rgba(6, 182, 212, 0.5) !important;
            box-shadow: 
                0 0 40px rgba(6, 182, 212, 0.15), 
                inset 0 0 20px rgba(6, 182, 212, 0.05) !important;
            border-radius: 4px !important;
            font-family: 'JetBrains Mono', monospace !important;
            padding: 10px !important;
            width: 100% !important; 
            max-width: 340px !important;
            
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)) !important;
            background-size: 100% 2px, 3px 100% !important;
        }

        .flatpickr-days {
            width: 100% !important;
        }
        
        .dayContainer {
            width: 100% !important;
            min-width: 0 !important;
            max-width: none !important;
            justify-content: space-around;
        }
        
        /* HIDDEN NAVIGATION BUTTONS (PREV/NEXT) */
        .flatpickr-prev-month, .flatpickr-next-month {
            display: none !important;
        }
        
        /* LOCKED MONTH/YEAR HEADER (STATIC VIEW ONLY) */
        .flatpickr-current-month {
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #06b6d4 !important;
            font-weight: 800 !important;
            padding-top: 5px;
            width: 100% !important;
            left: 0 !important;
            pointer-events: none !important; /* DISALBE INTERACTION */
        }

        /* Remove dropdown style and spinner from month/year */
        .flatpickr-monthDropdown-months, 
        .flatpickr-current-month input.cur-year {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: inherit !important;
            font-weight: inherit !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            pointer-events: none !important;
        }
        
        /* Hide year spinner arrows */
        .numInputWrapper span {
            display: none !important;
        }

        .flatpickr-weekdays {
            background: transparent !important;
            border-bottom: 1px solid rgba(6, 182, 212, 0.3) !important;
            margin-bottom: 10px !important;
        }
        
        .flatpickr-day {
            border-radius: 2px !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
            color: #cbd5e1 !important;
            transition: all 0.1s !important;
            margin: 1px !important;
            height: 38px !important;
            line-height: 38px !important;
            flex-basis: 14% !important;
            max-width: 14% !important;
        }
        
        .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay {
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .flatpickr-day:hover {
            background: rgba(6, 182, 212, 0.2) !important;
            border-color: rgba(6, 182, 212, 0.8) !important;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.4) !important;
            transform: scale(1.1);
            z-index: 10;
        }
        
        .flatpickr-day.selected {
            background: #06b6d4 !important;
            border: 1px solid #fff !important;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.8) !important;
            color: #000 !important;
            font-weight: 900 !important;
            animation: pulse-select 1.5s infinite;
        }

        @keyframes pulse-select {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }

        .flatpickr-day.flatpickr-disabled {
            opacity: 0.1 !important;
            cursor: not-allowed !important;
            border: none !important;
        }

        .flatpickr-day.already-filled-date {
            background: rgba(16, 185, 129, 0.15) !important;
            border: 1px solid rgba(16, 185, 129, 0.5) !important;
            color: #34d399 !important;
            box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.2);
        }
        .flatpickr-day.already-filled-date::after {
            content: '✓';
            position: absolute;
            top: 2px; right: 2px;
            font-size: 8px;
            color: #34d399;
        }
        
        /* Confetti Container */
        #confetti-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        textarea::-webkit-scrollbar { width: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #1e293b; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-3 md:p-6 selection:bg-cyan-500 selection:text-black">

    <!-- Starfield & Ambient -->
    <canvas id="starfield" class="fixed inset-0 w-full h-full z-[-2]"></canvas>
    <div class="ambient-light"></div>
    <canvas id="confetti-canvas"></canvas>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-6 z-50 flex items-center gap-4 px-4 py-4 rounded-lg shadow-2xl border-l-4 border-cyan-500">
        <div id="toast-icon" class="text-2xl flex-shrink-0"></div>
        <div>
            <h4 class="text-xs font-bold uppercase tracking-widest text-cyan-400 mb-1">System Message</h4>
            <p id="toast-message" class="text-sm font-medium text-slate-200 leading-snug"></p>
        </div>
    </div>

    <!-- Main Card -->
    <main class="pro-card w-full max-w-3xl rounded-2xl md:rounded-3xl p-6 md:p-12 z-10 animate-[fadeIn_0.8s_ease-out] mx-auto">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 md:mb-10 border-b border-white/5 pb-6">
            <div class="w-full md:w-auto">
                <div class="flex flex-wrap items-center gap-2 mb-2">
                    <span class="h-2 w-2 rounded-full bg-cyan-400 animate-pulse"></span>
                    <span class="text-xs font-mono text-cyan-400 uppercase tracking-widest">Workspace v2.0 <span class="text-slate-600 mx-1">|</span> <span id="live-clock" class="text-slate-400 whitespace-nowrap">00:00:00</span></span>
                </div>
                <!-- Responsive Title Size -->
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tighter text-white leading-tight">
                    BISWAJIT <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-violet-500">SAHOO</span>
                </h1>
                <p class="text-sm md:text-base text-slate-400 mt-1 font-light tracking-wide">Daily Engineering Progress Log</p>
            </div>

            <button id="manual-trigger-btn" class="mt-4 md:mt-0 w-full md:w-auto group flex items-center justify-center md:justify-start gap-3 px-4 py-2 rounded-lg bg-black/40 border border-white/10 hover:border-cyan-500/50 transition-all cursor-pointer">
                <div class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <div class="absolute inset-0 bg-green-500 rounded-full animate-ping opacity-75"></div>
                </div>
                <div class="flex flex-col text-left">
                    <span class="text-[10px] uppercase text-slate-500 font-bold group-hover:text-cyan-400 transition-colors">N8N Engine</span>
                    <span class="text-xs font-mono text-white">Online</span>
                </div>
            </button>
        </header>

        <!-- Form -->
        <form id="log-form" class="space-y-6 md:space-y-8" onsubmit="return false;">
            
            <!-- Meta Data Grid -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
                <!-- Log ID -->
                <div class="md:col-span-3">
                    <label for="si_no" class="pro-label">Log Sequence</label>
                    <input type="number" id="si_no" name="si_no" class="pro-input w-full p-3 md:p-3 rounded-lg text-center font-bold text-lg text-cyan-400 focus:text-cyan-300" readonly placeholder="--">
                </div>
                <!-- Date -->
                <div class="md:col-span-9">
                    <label for="date" class="pro-label">Date Entry</label>
                    <div class="relative group">
                        <!-- REMOVED SVG ICON AND ADJUSTED PADDING FOR CLEAN TEXT ONLY -->
                        <input type="text" id="date" name="date" class="pro-input w-full p-3 md:p-3 rounded-lg pl-12 cursor-pointer text-slate-300 group-hover:text-cyan-300 transition-colors" placeholder="YYYY-MM-DD" required>
                    </div>
                </div>
            </div>

            <!-- Work Report Section -->
            <div class="relative group">
                <div class="flex flex-row justify-between items-center mb-2">
                    <label for="work_done" class="pro-label text-cyan-400">Activity Report</label>
                    
                    <!-- AI Button -->
                    <button type="button" id="gemini-suggest-btn" class="btn-ai">
                        <svg class="w-4 h-4 text-violet-400 animate-pulse flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span>AI Enhance</span>
                    </button>
                </div>
                
                <div class="relative">
                    <textarea id="work_done" name="work_done" rows="6" 
                        class="pro-input w-full p-4 rounded-lg leading-relaxed text-slate-300 focus:text-white resize-none" 
                        placeholder="Detail your tasks, bugs fixed, or features implemented... (Tip: Press Ctrl+Enter to submit)" required></textarea>
                    
                    <!-- Decorative accents -->
                    <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-500 pointer-events-none opacity-50"></div>
                    <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-500 pointer-events-none opacity-50"></div>
                </div>

                <!-- Quick Task Chips -->
                <div class="flex flex-wrap gap-2 mt-3 items-center">
                    <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold mr-1 hidden xs:inline">Quick Add:</span>
                    <button type="button" class="chip" onclick="addText('Daily Scrum')">Scrum</button>
                    <button type="button" class="chip" onclick="addText('Bug Fixes:')">Fixes</button>
                    <button type="button" class="chip" onclick="addText('Code Review')">Review</button>
                    <button type="button" class="chip" onclick="addText('Feature Dev:')">Feature</button>
                    <button type="button" class="chip" onclick="addText('Docs Update')">Docs</button>
                </div>

                <div class="text-right mt-1">
                    <span id="save-status" class="text-[10px] text-cyan-500/70 font-mono tracking-widest uppercase opacity-0 transition-opacity">Saved locally</span>
                </div>
            </div>

            <!-- Timing Control Panel -->
            <div class="bg-black/20 rounded-2xl p-4 md:p-6 border border-white/5 relative overflow-hidden">
                <!-- Background grid for tech feel -->
                <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>

                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6 md:gap-8 items-center relative z-10">
                    
                    <!-- Start -->
                    <div class="order-1 md:order-none">
                        <label for="in_time" class="pro-label">Clock In</label>
                        <input type="time" id="in_time" name="in_time" class="pro-input w-full p-4 rounded-lg text-center text-xl font-mono tracking-widest text-cyan-300" required>
                    </div>

                    <!-- Gauge -->
                    <div class="flex flex-col items-center justify-center relative order-2 md:order-none my-2 md:my-0">
                        <div class="widget-gauge group cursor-default">
                            <div class="ring-active"></div>
                            <div id="duration-content" class="widget-content flex flex-col items-center">
                                <span class="text-2xl font-bold text-white font-mono">--</span>
                            </div>
                        </div>
                        <span class="absolute -bottom-6 text-[10px] uppercase tracking-[0.2em] text-slate-500 font-bold">Duration</span>
                    </div>

                    <!-- End -->
                    <div class="order-3 md:order-none">
                        <label for="out_time" class="pro-label">Clock Out</label>
                        <input type="time" id="out_time" name="out_time" class="pro-input w-full p-4 rounded-lg text-center text-xl font-mono tracking-widest text-violet-300" required>
                    </div>
                </div>
            </div>

            <!-- Action Area -->
            <div class="pt-2 md:pt-4">
                <button type="submit" id="submit-btn" class="btn-primary w-full py-4 md:py-5 rounded-lg font-black text-white text-lg shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95" disabled>
                    <span>TRANSMIT REPORT</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>

        </form>
    </main>

    <footer class="fixed bottom-4 left-4 text-[10px] text-slate-600 font-mono tracking-widest pointer-events-none hidden md:block">
        SECURE CONNECTION ESTABLISHED • N8N PROTOCOL ACTIVE
    </footer>

    <!-- LOGIC SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // --- Quick Add Function ---
        function addText(text) {
            const textarea = document.getElementById('work_done');
            if (textarea.value.length > 0) {
                textarea.value += '\n- ' + text + ' ';
            } else {
                textarea.value = '- ' + text + ' ';
            }
            textarea.dispatchEvent(new Event('input'));
            textarea.focus();
        }

        // --- Live Clock ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-clock').textContent = now.toLocaleTimeString('en-US', {hour12: false});
        }, 1000);

        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. VISUAL EFFECTS ---
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            const stars = [];
            const numStars = window.innerWidth < 600 ? 150 : 300; 
            
            const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            class Star {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 1.5;
                    this.speed = Math.random() * 0.2 + 0.05;
                    this.alpha = Math.random();
                }
                update() {
                    this.y -= this.speed;
                    if (this.y < 0) this.reset();
                }
                draw() {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
            }
            for(let i=0; i<numStars; i++) stars.push(new Star());
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                stars.forEach(star => { star.update(); star.draw(); });
                requestAnimationFrame(animate);
            }
            animate();

            // --- Confetti Effect ---
            const cCanvas = document.getElementById('confetti-canvas');
            const cCtx = cCanvas.getContext('2d');
            let confetti = [];
            function resizeConfetti() { cCanvas.width = window.innerWidth; cCanvas.height = window.innerHeight; }
            window.addEventListener('resize', resizeConfetti);
            resizeConfetti();

            function fireConfetti() {
                confetti = [];
                for(let i=0; i<100; i++) {
                    confetti.push({
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 20,
                        vy: (Math.random() - 0.5) * 20,
                        color: `hsl(${Math.random()*360}, 100%, 50%)`,
                        life: 100
                    });
                }
                animateConfetti();
            }
            function animateConfetti() {
                cCtx.clearRect(0, 0, cCanvas.width, cCanvas.height);
                confetti.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--;
                    cCtx.fillStyle = p.color; cCtx.fillRect(p.x, p.y, 5, 5);
                    if(p.life <= 0) confetti.splice(i, 1);
                });
                if(confetti.length > 0) requestAnimationFrame(animateConfetti);
            }

            // --- 2. CONFIG & VARIABLES ---
            const N8N_REWRITE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/AI_GenerateWorkDone";
            const N8N_SUBMIT_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/submitButton";
            const N8N_DATE_FILL_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/dateFill";
            const N8N_EDIT_WORK_DONE_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/editWorkDone";
            const N8N_MANUAL_TRIGGER_URL = "https://nucleoplasmic-maci-semiannually.ngrok-free.dev/webhook/manualTrigger";

            const logForm = document.getElementById('log-form');
            const submitBtn = document.getElementById('submit-btn');
            const workDoneTextarea = document.getElementById('work_done');
            const suggestBtn = document.getElementById('gemini-suggest-btn');
            const manualTriggerBtn = document.getElementById('manual-trigger-btn');
            const siNoInput = document.getElementById('si_no');
            const dateInput = document.getElementById('date');
            const inTimeInput = document.getElementById('in_time');
            const outTimeInput = document.getElementById('out_time');
            const durationContent = document.getElementById('duration-content');
            const toastEl = document.getElementById('toast-notification');
            const saveStatusEl = document.getElementById('save-status');

            let filledDays = [];

            // --- 3. HELPER FUNCTIONS ---
            function showMessage(msg, isError = false) {
                const icon = document.getElementById('toast-icon');
                const text = document.getElementById('toast-message');
                text.textContent = msg;
                if (isError) {
                    icon.innerHTML = '⚠️';
                    toastEl.classList.remove('border-cyan-500');
                    toastEl.classList.add('border-red-500');
                } else {
                    icon.innerHTML = '✅';
                    toastEl.classList.add('border-cyan-500');
                    toastEl.classList.remove('border-red-500');
                }
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 4000);
            }

            function formatTimeForN8N(time24h) {
                if (!time24h) return '';
                const [hours, minutes] = time24h.split(':').map(Number);
                let h = hours; const m = String(minutes).padStart(2, '0'); let modifier = 'AM';
                if (h === 0) h = 12; else if (h === 12) modifier = 'PM'; else if (h > 12) { h = h - 12; modifier = 'PM'; }
                return `${h}:${m} ${modifier}`;
            }

            function convert12hTo24h(timeStr) {
                if (!timeStr) return '';
                const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
                if (!match) return '';
                let [_, hours, minutes, modifier] = match; hours = parseInt(hours, 10);
                if (hours === 12 && modifier.toUpperCase() === 'AM') hours = 0; else if (hours !== 12 && modifier.toUpperCase() === 'PM') hours += 12;
                return `${String(hours).padStart(2, '0')}:${minutes}`;
            }

            function calculateEndTime(startTime24h) {
                if (!startTime24h) return '';
                const [startHour, startMinute] = startTime24h.split(':').map(Number);
                const shiftHours = 9; const shiftMinutes = 5;
                let endMinute = startMinute + shiftMinutes; let carryHour = 0;
                if (endMinute >= 60) { endMinute -= 60; carryHour = 1; }
                let endHour = startHour + shiftHours + carryHour;
                if (endHour >= 24) endHour %= 24;
                return `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
            }

            async function fetchWithExponentialBackoff(url, options, retries = 4, delay = 1000) {
                try { return await fetch(url, options); } 
                catch (error) {
                    if (retries > 0) { await new Promise(resolve => setTimeout(resolve, delay)); return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2); } 
                    else { throw error; }
                }
            }

            // --- 4. CORE LOGIC ---
            workDoneTextarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!submitBtn.disabled) { logForm.dispatchEvent(new Event('submit')); } 
                    else { showMessage("Please fill all fields first", true); }
                }
            });

            function saveToLocal() {
                localStorage.setItem('dailyLog_draft', workDoneTextarea.value);
                saveStatusEl.style.opacity = '1';
                setTimeout(() => saveStatusEl.style.opacity = '0', 2000);
            }
            const savedDraft = localStorage.getItem('dailyLog_draft');
            if(savedDraft && !workDoneTextarea.value) { workDoneTextarea.value = savedDraft; }
            workDoneTextarea.addEventListener('input', () => { saveToLocal(); checkFormValidity(); });

            async function fetchFilledDates(instance) {
                try {
                    const response = await fetchWithExponentialBackoff(N8N_DATE_FILL_URL, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data && Array.isArray(data.AlreadyFieldDate)) {
                            filledDays = data.AlreadyFieldDate.map(d => Number(d));
                            if (instance) instance.redraw();
                        }
                    }
                } catch (error) { console.error("Date fetch error", error); }
            }
            fetchFilledDates(null); 

            async function fetchWorkDoneForDate(dayNumber) {
                showMessage("Syncing database...");
                try {
                    const response = await fetchWithExponentialBackoff(N8N_EDIT_WORK_DONE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({ "preFieldDate": String(dayNumber) })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const record = data.PreFieldValueBasedOnDate;
                        if (record) {
                            if (record["SI No"]) siNoInput.value = record["SI No"];
                            if (record["WorkDone"] && record["WorkDone"].trim() !== "") {
                                workDoneTextarea.value = record["WorkDone"];
                                if (record["InTime"]) inTimeInput.value = convert12hTo24h(record["InTime"]);
                                if (record["OutTime"]) outTimeInput.value = convert12hTo24h(record["OutTime"]);
                                showMessage("Entry loaded.");
                            } else {
                                workDoneTextarea.value = "";
                                setDefaultTimes();
                            }
                            updateDurationDisplay(); checkFormValidity();
                        }
                    }
                } catch (error) { showMessage("Sync failed.", true); }
            }

            // --- FLATPICKR CONFIG ---
            const fp = flatpickr("#date", {
                dateFormat: "Y-m-d",
                theme: "dark",
                disableMobile: true, // STRICTLY TRUE (Boolean)
                maxDate: "today", 
                minDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // LOCK TO CURRENT MONTH START
                onOpen: (selectedDates, dateStr, instance) => {
                    fetchFilledDates(instance); 
                },
                onDayCreate: (dObj, dStr, fp, dayElem) => {
                    if (dayElem.classList.contains("prevMonthDay") || dayElem.classList.contains("nextMonthDay")) return;
                    const dayNumber = dayElem.dateObj.getDate();
                    if (filledDays.includes(dayNumber)) {
                        dayElem.classList.add("already-filled-date");
                    }
                },
                onChange: (selectedDates, dateStr, instance) => {
                    dateInput.value = dateStr;
                    dateInput.dispatchEvent(new Event('input'));
                    if (selectedDates.length > 0) fetchWorkDoneForDate(selectedDates[0].getDate());
                }
            });

            function updateDurationDisplay() {
                const startVal = inTimeInput.value; const endVal = outTimeInput.value;
                if (!startVal || !endVal) { durationContent.innerHTML = `<span class="text-2xl font-bold text-slate-500">--</span>`; return; }
                const [startH, startM] = startVal.split(':').map(Number); const [endH, endM] = endVal.split(':').map(Number);
                let startTotalMins = (startH * 60) + startM; let endTotalMins = (endH * 60) + endM;
                if (endTotalMins < startTotalMins) endTotalMins += (24 * 60);
                const diffMins = endTotalMins - startTotalMins;
                const hours = Math.floor(diffMins / 60); const minutes = diffMins % 60;
                if (minutes === 0) {
                    durationContent.innerHTML = `<span class="text-4xl font-black text-white leading-none tracking-tighter">${hours}<span class="text-lg text-cyan-400 align-top">h</span></span>`;
                } else {
                    durationContent.innerHTML = `<div class="flex flex-col leading-none"><span class="text-3xl font-bold text-white tracking-tighter">${hours}<span class="text-sm text-cyan-400">h</span></span><span class="text-xl font-medium text-violet-400 tracking-tighter">${minutes}<span class="text-xs">m</span></span></div>`;
                }
            }

            function setDefaultTimes() {
                const today = new Date();
                const h = String(today.getHours()).padStart(2, '0'); const m = String(today.getMinutes()).padStart(2, '0');
                const time = `${h}:${m}`; inTimeInput.value = time; outTimeInput.value = calculateEndTime(time);
            }

            function initializeDateTime() {
                const today = new Date();
                const y = today.getFullYear(); const m = String(today.getMonth() + 1).padStart(2, '0'); const d = String(today.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${d}`;
                fp.setDate(dateStr); siNoInput.value = d; setDefaultTimes(); updateDurationDisplay();
            }

            function checkFormValidity() {
                const isValid = siNoInput.value.trim() !== '' && dateInput.value.trim() !== '' && workDoneTextarea.value.trim() !== '' && inTimeInput.value.trim() !== '' && outTimeInput.value.trim() !== '';
                submitBtn.disabled = !isValid;
                if(isValid) { submitBtn.classList.add('brightness-110'); } else { submitBtn.classList.remove('brightness-110'); }
            }

            // --- EVENT LISTENERS ---
            [dateInput, inTimeInput, outTimeInput].forEach(el => {
                el.addEventListener('input', () => {
                    if (el === inTimeInput) { outTimeInput.value = calculateEndTime(el.value); }
                    if (el === dateInput && el.value) { siNoInput.value = new Date(el.value).getDate(); }
                    updateDurationDisplay(); checkFormValidity();
                });
            });

            manualTriggerBtn.addEventListener('click', async () => {
                const statusSpan = manualTriggerBtn.querySelector('span:last-child');
                const originalText = statusSpan.textContent;
                statusSpan.textContent = "PINGING...";
                manualTriggerBtn.classList.add('animate-pulse');
                try {
                    await fetchWithExponentialBackoff(N8N_MANUAL_TRIGGER_URL, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } });
                    showMessage("Engine Triggered");
                } catch (error) { showMessage("Signal sent (blind)", false); } 
                finally { setTimeout(() => { statusSpan.textContent = originalText; manualTriggerBtn.classList.remove('animate-pulse'); }, 1000); }
            });

            suggestBtn.addEventListener('click', async () => {
                const query = workDoneTextarea.value.trim();
                if (!query) return showMessage("Type a rough draft first.", true);
                
                const originalHTML = suggestBtn.innerHTML;
                suggestBtn.innerHTML = `<svg class="animate-spin h-3 w-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>PROCESSING</span>`;
                suggestBtn.disabled = true;
                
                try {
                    const response = await fetchWithExponentialBackoff(N8N_REWRITE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ keywords: query }) });
                    let resultText = "";
                    try { const json = await response.json(); resultText = json.rewritten_text || await response.text(); } catch(e) { resultText = await response.text(); }
                    if (resultText) { workDoneTextarea.value = resultText.trim(); saveToLocal(); showMessage("Content polished."); }
                } catch (error) { showMessage("AI Service Unavailable", true); } 
                finally { suggestBtn.innerHTML = originalHTML; suggestBtn.disabled = false; checkFormValidity(); }
            });

            logForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (submitBtn.disabled) return;
                const [sH, sM] = inTimeInput.value.split(':').map(Number); const [eH, eM] = outTimeInput.value.split(':').map(Number);
                if ((sH % 12 || 12) === (eH % 12 || 12) && Math.abs(sH - eH) !== 0) { return showMessage("Check AM/PM logic.", true); }
                if (sM === eM && sH === eH) { return showMessage("Start and end time cannot be identical.", true); }

                const originalHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = `<span class="animate-pulse">TRANSMITTING...</span>`;
                submitBtn.disabled = true;

                const payload = {
                    "Log ID": siNoInput.value,
                    "Date": dateInput.value,
                    "Daily Status Report": workDoneTextarea.value,
                    "StartTime": formatTimeForN8N(inTimeInput.value),
                    "EndTime": formatTimeForN8N(outTimeInput.value),
                    "submittedAt": new Date().toISOString(),
                    "formMode": "web-submission"
                };

                try {
                    const response = await fetchWithExponentialBackoff(N8N_SUBMIT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        fireConfetti();
                        showMessage("Report Logged Successfully!");
                        logForm.reset();
                        localStorage.removeItem('dailyLog_draft'); 
                        initializeDateTime();
                        checkFormValidity();
                    } else { throw new Error("API responded with error"); }
                } catch (error) { showMessage("Transmission failed.", true); } 
                finally { submitBtn.innerHTML = originalHTML; if (!submitBtn.disabled) submitBtn.disabled = false; }
            });

            initializeDateTime();
            checkFormValidity();
        });
    </script>
</body>
</html>
